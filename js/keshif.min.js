function Tipsy(t,e){this.jq_element=$(t),this.options=$.extend({},this.defaults,e)}"undefined"!=typeof google&&google.load("visualization","1",{packages:[]}),"function"!=typeof sendLog&&(sendLog=null);var kshf={queryURL_base:"https://docs.google.com/spreadsheet/tq?key=",surrogateCtor:function(){},extendClass:function(t,e){this.surrogateCtor.prototype=t.prototype,e.prototype=new this.surrogateCtor,e.prototype.constructor=e},num_of_charts:0,maxVisibleItems_default:100,dt:{},dt_id:{},dt_ColNames:{},dt_ColNames_Arr:{},createColumnNames:function(t){this.dt_ColNames[t]={},this.dt_ColNames_Arr[t]=[]},insertColumnName:function(t,e,i){this.dt_ColNames[t][e]=i,this.dt_ColNames_Arr[t][i]=e},LOG:{CONFIG:1,FILTER_ADD:10,FILTER_CLEAR:11,FILTER_CLEAR_ALL:12,FILTER_ATTR_ADD_AND:13,FILTER_ATTR_ADD_OR:14,FILTER_ATTR_ADD_ONE:15,FILTER_ATTR_ADD_OR_ALL:16,FILTER_ATTR_ADD_NOT:17,FILTER_ATTR_EXACT:18,FILTER_ATTR_UNSELECT:19,FILTER_TEXTSEARCH:20,FILTER_INTRVL_HANDLE:21,FILTER_INTRVL_BIN:22,FILTER_CLEAR_X:23,FILTER_CLEAR_CRUMB:24,FILTER_PREVIEW:25,FACET_COLLAPSE:40,FACET_SHOW:41,FACET_SORT:42,FACET_SCROLL_TOP:43,FACET_SCROLL_MORE:44,LIST_SORT:50,LIST_SCROLL_TOP:51,LIST_SHOWMORE:52,ITEM_DETAIL_ON:60,ITEM_DETAIL_OFF:61,DATASOURCE:70,INFOBOX:71,CLOSEPAGE:72,BARCHARTWIDTH:73,RESIZE:74}};kshf.Util={dif_aggregate_Active:function(t,e){return e.aggregate_Active-t.aggregate_Active},sortFunc_aggreage_Active_Total:function(t,e){var i=kshf.Util.dif_aggregate_Active(t,e);return 0===i?e.aggregate_Total-t.aggregate_Total:i},sortFunc_Column_Int_Incr:function(t,e){return t.data[1]-e.data[1]},sortFunc_Column_Int_Decr:function(t,e){return e.data[1]-t.data[1]},sortFunc_Column_ParseInt_Incr:function(t,e){return parseFloat(t.data[1],10)-parseFloat(e.data[1],10)},sortFunc_Column_ParseInt_Decr:function(t,e){return parseFloat(e.data[1],10)-parseFloat(t.data[1],10)},sortFunc_String_Decr:function(t,e){return e.data[1].localeCompare(t.data[1])},sortFunc_String_Incr:function(t,e){return e.data[1].localeCompare(t.data[1])},sortFunc_Time_Last:function(t,e){return void 0!==t.xMax_Dyn&&void 0!==e.xMax_Dyn?e.xMax_Dyn-t.xMax_Dyn:void 0===t.xMax_Dyn&&void 0===e.xMax_Dyn?e.xMax-t.xMax:void 0===e.xMax_Dyn?-1:1},sortFunc_Time_First:function(t,e){return void 0!==t.xMax_Dyn&&void 0!==e.xMax_Dyn?t.xMin_Dyn-e.xMin_Dyn:void 0===t.xMax_Dyn&&void 0===e.xMax_Dyn?t.xMin-e.xMin:void 0===e.xMin_Dyn?-1:1},sortFunc_List_String:function(t,e){return t.localeCompare(e)},sortFunc_List_Date:function(t,e){return null===t?-1:null===e?1:t.getTime()-e.getTime()},sortFunc_List_Number:function(t,e){return e-t},cellToArray:function(t,e,i,s){void 0===i&&(i=/\b\s+/);var a;t.forEach(function(t){t=t.data,e.forEach(function(e){var r=t[e];if(null!==r&&"number"!=typeof r){var n=r.split(i);for(r=[],a=0;a<n.length;a++)n[a]=n[a].trim(),""!==n[a]&&r.push(n[a]);if(s!==!1)for(a=0;a<r.length;a++)r[a]=parseInt(r[a],10);t[e]=r}})})},unescapeCommas:function(t){var e,i=!1,s=[];return t.forEach(function(t){if(i){if(e+=","+t,'"'!==t[t.length-1])return;i=!1}else{if('"'===t[0])return i=!0,e=t.slice(1,t.length-1),void 0;e=t}var a=+e;isNaN(a)||""===e||(e=a),s.push(e)}),s},formatForItemCount:function(t){if(1e3>t)return t;if(1e6>t){var e=t/1e3;return 10>e?Math.floor(t/100)/10+"k":Math.floor(e)+"k"}return 1e9>t?Math.floor(t/1e6)+"m":t},nearestYear:function(t){var e=new Date(Date.UTC(t.getUTCFullYear(),0,1));return t.getUTCMonth()>6&&e.setUTCFullYear(e.getUTCFullYear()+1),e},nearestMonth:function(t){var e=new Date(Date.UTC(t.getUTCFullYear(),t.getUTCMonth(),1));return t.getUTCDate()>15&&e.setUTCMonth(e.getUTCMonth()+1),e},nearestDay:function(t){var e=new Date(Date.UTC(t.getUTCFullYear(),t.getUTCMonth(),t.getUTCDate()));return t.getUTCHours()>12&&e.setUTCDate(e.getUTCDate()+1),e},nearestHour:function(){},nearestMinute:function(){},clearArray:function(t){for(;t.length>0;)t.pop()},ignoreScrollEvents:!1,scrollToPos_do:function(t,e){kshf.Util.ignoreScrollEvents=!0;var i=null,s=t.scrollTop,a=d3.ease("cubic-in-out"),r=500,n=function(o){var l;null===i&&(i=o),l=(o-i)/r;var h=a(l);t.scrollTop=(1-h)*s+h*e,t.scrollTop!==e?window.requestAnimationFrame(n):kshf.Util.ignoreScrollEvents=!1};window.requestAnimationFrame(n)},toProperCase:function(t){return t.toLowerCase().replace(/\b[a-z]/g,function(t){return t.toUpperCase()})},setTransform:function(t,e){t.style.webkitTransform=e,t.style.MozTransform=e,t.style.msTransform=e,t.style.OTransform=e,t.style.transform=e},insertHeader:function(){var t=this;this.dom.headerGroup=this.divRoot.append("div").attr("class","headerGroup"),this.dom.headerGroup.append("div").attr("class","border_line"),this.dom.headerGroup.append("span").attr("class","header_label_arrow").each(function(){this.tipsy=new Tipsy(this,{gravity:"sw",title:function(){return t.collapsed?"Expand facet":"Collapse facet"}})}).on("mouseover",function(){this.tipsy.show()}).on("mouseout",function(){this.tipsy.hide()}).on("click",function(){this.tipsy.hide(),t.collapseFacet(!t.collapsed)}).append("span").attr("class","fa");var e=this.dom.headerGroup.append("span").style("position","relative");e.append("span").attr("class","chartFilterButtonParent").append("div").attr("class","chartClearFilterButton rowFilter alone").each(function(){this.tipsy=new Tipsy(this,{gravity:"n",title:function(){return"<span class='action'><span class='fa fa-times'></span> Remove</span> filter"}})}).on("mouseover",function(){this.tipsy.show()}).on("mouseout",function(){this.tipsy.hide()}).on("click",function(){this.tipsy.hide(),t.facetFilter.clearFilter(),sendLog&&sendLog(kshf.LOG.FILTER_CLEAR_X,{id:t.facetFilter.id})}).append("span").attr("class","fa fa-times"),e.append("span").attr("class","header_label").html(this.parentFacet&&this.parentFacet.hasAttribs()?"<i class='fa fa-hand-o-up'></i> <span style='font-weight:500'>"+this.parentFacet.options.facetTitle+":</span> "+"  "+this.options.facetTitle:this.options.facetTitle).on("click",function(){t.collapsed&&t.collapseFacet(!1)}),e.append("span").attr("class","").attr("class","save_filter_as_set fa fa-save").each(function(){this.tipsy=new Tipsy(this,{gravity:"n",title:function(){return"Save filter as option"}})}).on("mouseover",function(){this.tipsy.show()}).on("mouseout",function(){this.tipsy.hide()}).on("click",function(){this.tipsy.hide(),t.facetFilter.saveFilter(),sendLog&&sendLog(kshf.LOG.FILTER_CLEAR_X,{id:t.facetFilter.id})});var i=this.dom.headerGroup.append("span").attr("class","facetIcons");i.append("span").attr("class","hasMultiMappings fa fa-ellipsis-v").each(function(){this.tipsy=new Tipsy(this,{gravity:"ne",title:function(){return"Multiple "+t.options.facetTitle+" possible"}})}).on("mouseover",function(){this.tipsy.show()}).on("mouseout",function(){this.tipsy.hide()}),this.isLinked&&i.append("span").attr("class","isLinkedMark fa fa-check-square-o"),this.options.description&&i.append("span").attr("class","facetDescription fa fa-info-circle").each(function(){this.tipsy=new Tipsy(this,{gravity:"ne",title:function(){return t.options.description}})}).on("mouseover",function(){this.tipsy.show()}).on("mouseout",function(){this.tipsy.hide()}),this.dom.headerGroup.append("div").attr("class","border_line")}};var activeTipsy=void 0;Tipsy.prototype={defaults:{className:null,delayOut:0,fade:!0,fallback:"",gravity:"n",offset:0,offset_x:0,offset_y:0,opacity:.9},show:function(){var t=function(t,e){return"function"==typeof t?t.call(e):t};activeTipsy&&activeTipsy.hide(),activeTipsy=this;var e=this.getTitle();if(e){var i=this.tip();i.find(".tipsy-inner").html(e),i[0].className="tipsy",i.remove().css({top:0,left:0,visibility:"hidden",display:"block"}).prependTo(document.body);var s,a=$.extend({},this.jq_element.offset(),{width:this.jq_element[0].offsetWidth,height:this.jq_element[0].offsetHeight}),r=i[0].offsetWidth,n=i[0].offsetHeight,o=t(this.options.gravity,this.jq_element[0]);switch(o.charAt(0)){case"n":s={top:a.top+a.height+this.options.offset,left:a.left+a.width/2-r/2};break;case"s":s={top:a.top-n-this.options.offset,left:a.left+a.width/2-r/2};break;case"e":s={top:a.top+a.height/2-n/2,left:a.left-r-this.options.offset};break;case"w":s={top:a.top+a.height/2-n/2,left:a.left+a.width+this.options.offset}}s.top+=this.options.offset_y,s.left+=this.options.offset_x,2==o.length&&(s.left="w"==o.charAt(1)?a.left+a.width/2-15:a.left+a.width/2-r+15),i.css(s).addClass("tipsy-"+o),i.find(".tipsy-arrow")[0].className="tipsy-arrow tipsy-arrow-"+o.charAt(0),this.options.className&&i.addClass(t(this.options.className,this.jq_element[0])),this.options.fade?i.stop().css({opacity:0,display:"block",visibility:"visible"}).animate({opacity:this.options.opacity},200):i.css({visibility:"visible",opacity:this.options.opacity})}},hide:function(){this.options.fade?this.tip().stop().fadeOut(200,function(){$(this).remove()}):this.tip().remove(),activeTipsy=void 0},getTitle:function(){var t,t,e=this.jq_element,i=this.options,i=this.options;return"string"==typeof i.title?t=e.attr("title"==i.title?"original-title":i.title):"function"==typeof i.title&&(t=i.title.call(e[0])),t=(""+t).replace(/(^\s*|\s*$)/,""),t||i.fallback},tip:function(){return this.jq_tip?this.jq_tip:(this.jq_tip=$('<div class="tipsy"></div>').html('<div class="tipsy-arrow"></div><div class="tipsy-inner"></div>'),this.jq_tip,this.jq_tip.data("tipsy-pointee",this.jq_element[0]),this.jq_tip)}},kshf.Item=function(t,e){this.data=t,this.idIndex=e,this.selected=0,this.items=[],this.aggregate_Self=1,this.aggregate_Active=0,this.aggregate_Preview=0,this.aggregate_Total=0,this._filterCacheIsDirty=!0,this.filterCache=[],this.isWanted=!0,this.wantedOrder=0,this.mappedDataCache=[],this.selectedForLink=!1,this.resultDOM=void 0,this.facetDOM=void 0,this.updatePreview_Cache=!1},kshf.Item.prototype={id:function(){return this.data[this.idIndex]},setFilterCache:function(t,e){this.filterCache[t]!==e&&(this.filterCache[t]=e,this._filterCacheIsDirty=!0)},f_selected:function(){return 0!==this.selected},f_included:function(){return this.selected>0},is_NONE:function(){return 0===this.selected},is_NOT:function(){return-1===this.selected},is_AND:function(){return 1===this.selected},is_OR:function(){return 2===this.selected},set_NONE:function(){void 0!==this.inList&&this.inList.splice(this.inList.indexOf(this),1),this.inList=void 0,this.selected=0,this._setFacetDOM()},set_NOT:function(t){this.is_NOT()||(this._insertToList(t),this.selected=-1,this._setFacetDOM())},set_AND:function(t){this.is_AND()||(this._insertToList(t),this.selected=1,this._setFacetDOM())},set_OR:function(t){this.is_OR()||(this._insertToList(t),this.selected=2,this._setFacetDOM())},_insertToList:function(t){void 0!==this.inList&&this.inList.splice(this.inList.indexOf(this),1),this.inList=t,t.push(this)},_setFacetDOM:function(){this.facetDOM&&this.facetDOM.setAttribute("selected",this.selected)},addItem:function(t){this.items.push(t),this.aggregate_Total+=t.aggregate_Self,this.aggregate_Active+=t.aggregate_Self},updateWanted:function(t){if(!this._filterCacheIsDirty)return!1;var e=this,i=this.isWanted;return this.isWanted=!0,this.filterCache.every(function(t){return e.isWanted=e.isWanted&&t,e.isWanted}),this.isWanted===!0&&i===!1?this.mappedDataCache.forEach(function(e){null!==e&&(e.h?e.b&&(e.b.aggregate_Active+=this.aggregate_Self):e.forEach(function(e){var i=e.aggregate_Active;e.aggregate_Active+=this.aggregate_Self,0===i&&e.facet&&(e.facet===t||e.facet.isLinked||e.mappedDataCache.forEach(function(t){null!==t&&(t.h?t.b&&(t.b.aggregate_Active+=e.aggregate_Self):t.forEach(function(t){t.aggregate_Active+=e.aggregate_Self}))}))},this))},this):this.isWanted===!1&&i===!0&&this.mappedDataCache.forEach(function(e){null!==e&&(e.h?e.b&&(e.b.aggregate_Active-=this.aggregate_Self):e.forEach(function(e){e.aggregate_Active-=this.aggregate_Self,0===e.aggregate_Active&&e.facet&&(e.facet===t||e.facet.isLinked||e.mappedDataCache.forEach(function(t){null!==t&&(t.h?t.b&&(t.b.aggregate_Active-=e.aggregate_Self):t.forEach(function(t){t.aggregate_Active-=e.aggregate_Self}))}))},this))},this),this._filterCacheIsDirty=!1,this.isWanted!==i},updateWanted_More:function(t){return this.isWanted?!1:this.updateWanted(t)},updateWanted_Less:function(t){return this.isWanted?this.updateWanted(t):!1},updatePreview:function(t){this.isWanted&&this.updatePreview_Cache===!1&&(this.updatePreview_Cache=!0,this.resultDOM&&this.resultDOM.setAttribute("highlight",!0),this.facet&&this.facet===t&&!this.facet.isLinked&&this.aggregate_Active>0&&this.items.forEach(function(t){t.updatePreview(this.facet)},this),t&&this.facet&&0===this.aggregate_Preview||this.mappedDataCache.forEach(function(e){null!==e&&(e.h?e.b&&e.b.aggregate_Active>0&&(e.b.aggregate_Preview+=this.aggregate_Self):e.forEach(function(e){e.aggregate_Preview+=this.aggregate_Self,1===e.aggregate_Preview&&e.facet&&(e.facet.isLinked||e.facet===t||e.updatePreview(t))},this))},this))},highlightAll:function(t){this.resultDOM&&this.resultDOM.setAttribute("highlight",t?"selected":!0),this.facetDOM&&this.facetDOM.setAttribute("highlight",t?"selected":!0),(!this.resultDOM||t)&&this.mappedDataCache.forEach(function(t){null!==t&&(t.h?t.h.setSelectedPosition(t.v):t.forEach(function(t){this.resultDOM&&t.resultDOM||t.highlightAll(!1)},this))},this)},nohighlightAll:function(t){this.resultDOM&&this.resultDOM.setAttribute("highlight",!1),this.facetDOM&&this.facetDOM.setAttribute("highlight",!1),(!this.resultDOM||t)&&this.mappedDataCache.forEach(function(t){null!==t&&(t.h?t.h.hideSelectedPosition(t.v):t.forEach(function(t){this.resultDOM&&t.resultDOM||t.nohighlightAll(!1)},this))},this)},setSelectedForLink:function(t){this.selectedForLink=t,this.resultDOM&&this.resultDOM.setAttribute("selectedForLink",t),t===!1&&this.set_NONE()}},kshf.Filter=function(t,e){this.isFiltered=!1,this.filterSummaryBlock=null,this.name=e.name,this.browser=e.browser,this.filteredItems=e.filteredItems,this.onClear=e.onClear,this.onFilter=e.onFilter,this.hideCrumb=e.hideCrumb,this.summary_header=e.summary_header,this.summary_item_cb=e.summary_item_cb,this.how="All",this.facet=e.facet?e.facet:this,this.id=t,this.isFiltered=!1,this.filteredItems.forEach(function(t){t.setFilterCache(this.id,!0)},this)},kshf.Filter.prototype={addFilter:function(t,e){var i=this.facet.parentFacet;this.isFiltered=!0,this.onFilter&&this.onFilter.call(this.facet,this);var s=!1;void 0===e&&(e=!0);var a=0;"LessResults"===this.how&&(a=-1),"MoreResults"===this.how&&(a=1),this.filteredItems.forEach(function(t){if(!(0>a&&!t.isWanted||a>0&&t.isWanted)){var r=t.updateWanted(e);s=s||r}i&&i.hasAttribs()&&(t.isWanted?t.set_OR(i.attribFilter.selected_OR):t.set_NONE())},this),i&&i.hasAttribs()&&(i.updateAttribCount_Wanted(),i.attribFilter.how="All",i.attribFilter.linkFilterSummary="",i.attribFilter.addFilter(!1,i),i._update_Selected()),this._refreshFilterSummary(),t===!0&&(this.browser.updateItemSelectedCt(),this.browser.refreshFilterClearAll(),s&&this.browser.update(-1),sendLog&&sendLog(kshf.LOG.FILTER_ADD,this.browser.getFilterState()))},clearFilter:function(t,e,i){if(this.isFiltered){var s=this.facet.parentFacet,a=!1;this.facet.hasEntityParent&&(a=this.facet.hasEntityParent()),this.isFiltered=!1,this.filteredItems.forEach(function(t){t.setFilterCache(this.id,!0)},this),this.onClear&&this.onClear.call(this.facet,this),void 0===e&&(e=!0),i!==!1&&this.filteredItems.forEach(function(t){t.isWanted||t.updateWanted(e),s&&s.hasAttribs()&&(t.isWanted?t.set_OR(s.attribFilter.selected_OR):t.set_NONE())}),this._refreshFilterSummary(),t!==!1&&(a&&(s.updateAttribCount_Wanted(),s.attribFilter.how="All",s.attribCount_Wanted===s.attribCount_Total?s.attribFilter.clearFilter(!1,s):(s.attribFilter.linkFilterSummary="",s.attribFilter.addFilter(!1,s))),this.facet.subFacets&&(this.facet.subFacets.forEach(function(t){t.facetFilter.clearFilter(!1,!1,!1)}),this.facet.subFacets.length>0&&this.facet._attribs.forEach(function(t){t.isWanted=!0,t._filterCacheIsDirty=!1})),this.browser.updateItemSelectedCt(),this.browser.refreshFilterClearAll(),this.browser.update(1),sendLog&&sendLog(kshf.LOG.FILTER_CLEAR,this.browser.getFilterState()))}},_refreshFilterSummary:function(){if(void 0===this.hideCrumb&&this.browser.subBrowser!==!0&&this.browser.isSmallWidth()&&(this.hideCrumb=!0),this.hideCrumb!==!0)if(this.isFiltered){if(null===this.filterSummaryBlock&&(this.filterSummaryBlock=this.insertFilterSummaryBlock()),void 0!==this.summary_header){var t=this.summary_header;this.browser.subBrowser===!0&&(t+=" ("+this.browser.itemName+")"),this.filterSummaryBlock.select(".summary_header").html(t)}if(void 0!==this.summary_item_cb){var t=this.summary_item_cb;"function"==typeof t&&(t=t.call(this)),this.filterSummaryBlock.select(".summary_details").html(t)}}else{var e=this.filterSummaryBlock;if(null===e||void 0===e)return;e.attr("ready",!1),setTimeout(function(){e[0][0].parentNode.removeChild(e[0][0])},350),this.filterSummaryBlock=null}},insertFilterSummaryBlock:function(){var t,e=this;t=this.browser.dom.filtercrumbs.append("span").attr("class","filter-block").each(function(){this.tipsy=new Tipsy(this,{gravity:"n",title:function(){return"<span class='action'><span class='fa fa-times'></span> Remove</span> filter"}})}).on("mouseenter",function(){this.tipsy.show(),d3.event.stopPropagation()}).on("mouseleave",function(){this.tipsy.hide(),d3.event.stopPropagation()}).on("click",function(){this.tipsy.hide(),e.clearFilter(),setTimeout(function(){e.browser.updateLayout_Height()},1e3),sendLog&&sendLog(kshf.LOG.FILTER_CLEAR_CRUMB,{id:this.id})}),t.append("span").attr("class","chartClearFilterButton summary").append("span").attr("class","fa fa-times");var i=t.append("span").attr("class","sdsdsds");return i.append("span").attr("class","summary_header"),i.append("span").attr("class","summary_details"),window.getComputedStyle(t[0][0]).opacity,t.attr("ready",!0),t}},kshf.List=function(t,e,i){var s=this;this.browser=t,this.dom={},this.scrollTop_cache=0,this.itemtoggledetailsWidth=18,this.stateWidth=15,this.linkColumnWidth=85,this.linkColumnWidth_ItemCount=25,this.linkColumnWidth_BarMax=this.linkColumnWidth-this.linkColumnWidth_ItemCount-3,this.selectColumnWidth=17,this.config=e,this.contentFunc=e.contentFunc,void 0!==e.content&&(this.contentFunc=this.browser.getColumnData(this.browser.primaryTableName,e.content)),this.autoExpandMore=!1,e.autoExpandMore&&(this.autoExpandMore=e.autoExpandMore),e.maxVisibleItems_Default&&(kshf.maxVisibleItems_default=e.maxVisibleItems_Default),this.maxVisibleItems=kshf.maxVisibleItems_default,this.hasLinkedItems=!1,void 0!==e.hasLinkedItems&&(this.hasLinkedItems=!0),this.hasLinkedItems&&(this.selectColumnWidth+=30,this.showSelectBox=!1,e.showSelectBox===!0&&(this.showSelectBox=!0),this.showSelectBox&&(this.selectColumnWidth+=17)),this.domStyle=e.domStyle,this.sortingOpts=e.sortingOpts,this.sortingOpts.forEach(function(t){void 0===t.value&&(t.value=this.browser.getColumnData(this.browser.primaryTableName,t.name)),t.label||(t.label=t.value),void 0===t.inverse&&(t.inverse=!1),void 0===t.func&&(t.func=s.getSortFunc(t.value))},this),this.sortingOpt_Active=this.sortingOpts[0],this.displayType="list","grid"===e.displayType&&(this.displayType="grid"),this.visibleCb=e.visibleCb,this.detailCb=e.detailCb,this.sortColWidth=e.sortColWidth,this.linkText="Related To",e.linkText&&(this.linkText=e.linkText),this.showRank=e.showRank,void 0===this.showRank&&(this.showRank=!1),this.textSearch=e.textSearch,this.textSearchFunc=e.textSearchFunc,void 0!==this.textSearch&&(void 0===this.textSearchFunc&&(this.textSearchFunc=this.browser.getColumnData(this.browser.primaryTableName,this.textSearch)),"*"===this.textSearch[0]&&(this.textSearch=this.textSearch.substring(1)),this.textSearch=kshf.Util.toProperCase(this.textSearch)),this.hideTextSearch=void 0===this.textSearchFunc,this.detailsToggle=e.detailsToggle,this.detailsToggle=void 0===this.detailsToggle?"off":this.detailsToggle.toLowerCase(),this.listDiv=i.select("div.listDiv").attr("detailsToggle",this.detailsToggle).attr("displayType",this.displayType),this.dom.leftBlockAdjustSize=this.listDiv.append("span").attr("class","leftBlockAdjustSize").attr("title","Drag to adjust panel width").on("mousedown",function(){if(1===d3.event.which){s.browser.root.style("cursor","ew-resize"),s.browser.root.attr("noanim",!0);var t=d3.mouse(this.parentNode.parentNode)[0],e=s.browser.barChartWidth;s.browser.root.on("mousemove",function(){var i=d3.mouse(this)[0],a=i-t,r=s.hideBarAxis;s.browser.setBarWidthLeftPanel(e+a),s.browser.hideBarAxis!==r&&s.browser.updateLayout_Height()}).on("mouseup",function(){s.browser.root.style("cursor","default"),s.browser.root.attr("noanim",!1),s.browser.root.on("mousemove",null).on("mouseup",null),sendLog&&sendLog(kshf.LOG.BARCHARTWIDTH,{info:s.browser.barChartWidth})}),d3.event.preventDefault()}}).on("click",function(){d3.event.stopPropagation(),d3.event.preventDefault()}),this.dom.listHeader=this.listDiv.append("div").attr("class","listHeader"),this.dom.listHeader_TopRow=this.dom.listHeader.append("div").attr("class","topRow"),this.dom.listHeader_BottomRow=this.dom.listHeader.append("div").attr("class","bottomRow").append("span").attr("class","bottomRowRow"),this.dom.listItemGroup=this.listDiv.append("div").attr("class","listItemGroup").on("scroll",function(){this.scrollHeight-this.scrollTop-this.offsetHeight<10?s.autoExpandMore===!1?s.dom.showMore.style("bottom","4px"):s.showMore():s.dom.showMore.style("bottom","-27px"),s.dom.scrollToTop.style("visibility",this.scrollTop>0?"visible":"hidden")}),this.sortFilters=[],"list"===this.displayType&&this.sortingOpts.forEach(function(e){this.sortFilters.push(t.createFilter({name:e.name,browser:this.browser,filteredItems:this.browser.items,facet:this,onClear:function(t){t.filterValue=""},onFilter:function(t){var e=this.sortingOpt_Active.label;t.filteredItems.forEach(function(i){i.setFilterCache(t.id,e(i)===t.filterValue)})},summary_header:e.name,summary_item_cb:function(){return"<b>"+this.filterValue+"</b>"}}))},this),this.sortFilter_Active=this.sortFilters[0],this.insertHeaderSortSelect(),this.dom.filtercrumbs=this.dom.listHeader_BottomRow.append("span").attr("class","filtercrumbs"),this.insertHeaderLinkedItems(),this.dom.scrollToTop=this.dom.listHeader_BottomRow.append("div").attr("class","scrollToTop").html("⬆").attr("title","Scroll To Top").on("click",function(){kshf.Util.scrollToPos_do(s.dom.listItemGroup[0][0],0),sendLog&&sendLog(kshf.LOG.LIST_SCROLL_TOP)}),this.sortItems(),this.insertItems(),this.dom.showMore=this.listDiv.append("div").attr("class","showMore").on("click",function(){s.showMore()}).on("mouseenter",function(){d3.select(this).selectAll(".loading_dots").attr("anim",!0)}).on("mouseleave",function(){d3.select(this).selectAll(".loading_dots").attr("anim",null)}),this.dom.showMore.append("span").attr("class","MoreText").html("Show More"),this.dom.showMore.append("span").attr("class","Count CountAbove"),this.dom.showMore.append("span").attr("class","Count CountBelow"),this.dom.showMore.append("span").attr("class","loading_dots loading_dots_1"),this.dom.showMore.append("span").attr("class","loading_dots loading_dots_2"),this.dom.showMore.append("span").attr("class","loading_dots loading_dots_3")},kshf.List.prototype={insertGlobalTextSearch:function(){var t,e=this;this.textFilter=this.browser.createFilter({name:"TextSearch",browser:this.browser,filteredItems:this.browser.items,facet:this,onClear:function(e){e.filterStr="",this.dom.mainTextSearch[0][0].value="",t.select(".clearText").style("display","none")},onFilter:function(i){i.filterStr=i.filterStr.split(" "),t.select(".clearText").style("display","inline-block"),i.filteredItems.forEach(function(t){var s=!i.filterStr.every(function(i){var s=e.textSearchFunc(t);return null===s||void 0===s?!0:-1===s.toLowerCase().indexOf(i)});t.setFilterCache(i.id,s)})},hideCrumb:!0}),t=this.dom.listHeader_TopRow.append("span").attr("class","mainTextSearch"),t.append("i").attr("class","fa fa-search searchIcon"),this.dom.mainTextSearch=t.append("input").attr("placeholder","Search "+(this.textSearch?this.textSearch:"title")).attr("autofocus","true").on("keydown",function(){var t=this;this.timer&&(clearTimeout(this.timer),this.timer=null),this.timer=setTimeout(function(){e.textFilter.filterStr=t.value.toLowerCase(),""!==e.textFilter.filterStr?e.textFilter.addFilter(!0):e.textFilter.clearFilter(),sendLog&&sendLog(kshf.LOG.FILTER_TEXTSEARCH,{id:e.textFilter.id,info:e.textFilter.filterStr}),t.timer=null},750)}),t.append("i").attr("class","fa fa-times-circle clearText").on("click",function(){e.textFilter.clearFilter()})},insertHeaderSortSelect:function(){var t=this,e=this.dom.listHeader_BottomRow.append("div").attr("class","listsortcolumn").style("width",this.sortColWidth+"px").style("white-space","nowrap");return"grid"===t.displayType&&e.append("span").attr("class","sortBy fa fa-sort-amount-desc"),1===this.sortingOpts.length?(e.append("span").html(this.sortingOpts[0].name),void 0):(e.append("select").attr("class","listSortOptionSelect").style("width",this.sortColWidth-("grid"===t.displayType?15:0)+"px").on("change",function(){t.sortingOpt_Active=t.sortingOpts[this.selectedIndex],t.sortFilter_Active=t.sortFilters[this.selectedIndex],t.reorderItemsOnDOM(),t.updateVisibleIndex(),t.maxVisibleItems=kshf.maxVisibleItems_default,t.updateItemVisibility(),"list"===t.displayType&&t.dom.listsortcolumn_label.html(function(e){return t.sortingOpt_Active.label(e)}).each(function(e){this.columnValue=t.sortingOpt_Active.label(e)}),sendLog&&sendLog(kshf.LOG.LIST_SORT,{info:this.selectedIndex})}).selectAll("input.list_sort_label").data(this.sortingOpts).enter().append("option").attr("class","list_sort_label").html(function(t){return t.name}),void 0)},insertHeaderLinkedItems:function(){var t=this;if(this.hasLinkedItems){var e=this.dom.listHeader_BottomRow.append("span").attr("class","headerLinkStateColumn");e.append("span").attr("class","linkTitleText").text(this.linkText);var i=e.append("span").attr("class","linkAll").each(function(){this.tipsy=new Tipsy(this,{gravity:"n",title:function(){return"<span class='action'><span class='fa fa-link'></span> Show</span> <br>"+t.linkText+"<br> all results"}})}).on("mouseover",function(){this.tipsy.show()}).on("mouseout",function(){this.tipsy.hide()}).on("click",function(){var e=t.browser.linkedFacets[0];e.attribFilter.linkFilterSummary=t.browser.getFilterSummary(),t.browser.clearFilters_All(!1);var i=e.attribFilter.selected_OR;t.browser.items.forEach(function(t){t.isWanted?(t.setSelectedForLink(!0),t.set_OR(i)):t.set_NONE()}),e.updateSorting(0),e._update_Selected(),e.attribFilter.how="All",e.attribFilter.addFilter(!0),setTimeout(function(){t.browser.updateLayout_Height()},1e3)});i.append("span").attr("class","fa fa-link"),i.append("span").attr("class","headerLinkColumnAllResults").html(" All <i class='fa fa-hand-o-down'></i>")}},insertItems:function(){var t=this;this.dom.listItems=this.dom.listItemGroup.selectAll("div.listItem").data(this.browser.items,function(t){return t.id()}).enter().append("div").attr("class",function(e){var i="listItem";return t.domStyle&&(i+=" "+t.domStyle.call(this,e)),i}).attr("details","false").attr("highlight",!1).attr("animSt","visible").attr("itemID",function(t){return t.id()}).each(function(t){t.resultDOM=this}).on("mouseenter",function(e){e.highlightAll(!0),t.hasLinkedItems&&e.resultDOM.setAttribute("selectedForLink",!0),e.items.forEach(function(t){t.highlightAll(!1)}),t.hasLinkedItems&&(e.items.forEach(function(t){t.updatePreview()}),t.browser.refreshResultPreview())}).on("mouseleave",function(e){d3.select(this).attr("highlight","false"),t.hasLinkedItems&&e.resultDOM.setAttribute("selectedForLink",!1),e.nohighlightAll(!0),e.items.forEach(function(t){t.nohighlightAll(!1)}),t.hasLinkedItems&&t.browser.clearResultPreview()}),this.hasLinkedItems&&this.dom.listItems.attr("selectedForLink","false"),"list"===this.displayType&&this.insertItemSortColumn(),"off"!==this.detailsToggle&&this.insertItemToggleDetails(),this.dom.listItems_Content=this.dom.listItems.append("div").attr("class","content").html(function(e){return t.contentFunc(e)}),this.hasLinkedItems&&(this.dom.itemLinkStateColumn=this.dom.listItems.append("span").attr("class","itemLinkStateColumn").style("width",this.selectColumnWidth+"px"),this.dom.itemLinkStateColumn.append("span").attr("class","itemLinkIcon fa fa-link").each(function(){this.tipsy=new Tipsy(this,{gravity:"n",title:function(){return"<span class='action'>Show</span> "+t.linkText+" <i class='fa fa-hand-o-left'></i> this"}})}).on("mouseenter",function(){this.tipsy.show()}).on("mouseout",function(){this.tipsy.hide()}).on("click",function(e){this.tipsy.hide(),t.browser.items.forEach(function(t){t.setSelectedForLink(!1)}),e.setSelectedForLink(!0),t.browser.clearFilters_All(!1),t.browser.linkedFacets.forEach(function(t){t.selectAllAttribsButton(),t.updateSorting(0)}),setTimeout(function(){t.browser.updateLayout_Height()},1e3)}),this.dom.itemLinkStateColumn_Count=this.dom.itemLinkStateColumn.append("span").attr("class","item_count").text(function(t){return t.aggregate_Active}),this.showSelectBox&&this.dom.itemLinkStateColumn.append("i").attr("class","itemSelectCheckbox").each(function(){this.tipsy=new Tipsy(this,{gravity:"n",title:function(){return"<span class='action'>Select</span> item"}})}).on("mouseenter",function(){this.tipsy.show()}).on("mouseout",function(){this.tipsy.hide()}).on("click",function(e){this.tipsy.hide(),e.setSelectedForLink(!e.selectedForLink),t.browser.linkedFacets.forEach(function(t){t.updateSorting(0)}),t.browser.updateLayout_Height()}))},insertItemSortColumn:function(){var t=this;this.dom.listsortcolumn=this.dom.listItems.append("div").attr("class","listsortcolumn").style("width",this.sortColWidth+"px").each(function(e){this.columnValue=t.sortingOpt_Active.label(e)}).each(function(){this.tipsy=new Tipsy(this,{gravity:"s",title:function(){return"<span class='action'><span class='fa fa-plus'></span> Add</span> <i>"+t.sortingOpt_Active.name+"</i> Filter"}})}).on("mouseover",function(){t.sortFilter_Active.isFiltered||this.tipsy.show()}).on("mouseout",function(){this.tipsy.hide()}).on("click",function(){t.sortFilter_Active.isFiltered||(this.tipsy.hide(),t.sortFilter_Active.filterValue=this.columnValue,t.sortFilter_Active.addFilter(!0))}),this.dom.listsortcolumn_label=this.dom.listsortcolumn.append("span").attr("class","columnLabel").html(function(e){return t.sortingOpt_Active.label(e)}),this.showRank&&(this.dom.ranks=this.dom.listsortcolumn.append("span").attr("class","itemRank"))},insertItemToggleDetails:function(){var t=this;"one"===this.detailsToggle&&"list"===this.displayType&&this.dom.listItems.append("div").attr("class","itemToggleDetails").each(function(t){this.tipsy=new Tipsy(this,{gravity:"s",title:function(){return t.showDetails===!0?"Show less":"Show more"}})}).append("span").attr("class","item_details_toggle fa fa-chevron-down").on("click",function(e){e.showDetails===!0?t.hideListItemDetails(e):t.showListItemDetails(e),this.parentNode.tipsy.hide()}).on("mouseover",function(){this.parentNode.tipsy.show()}).on("mouseout",function(){this.parentNode.tipsy.hide()}),"zoom"===this.detailsToggle&&this.dom.listItems.append("div").attr("class","itemToggleDetails").each(function(){this.tipsy=new Tipsy(this,{gravity:"s",title:function(){return"Get more info"}})}).append("span").attr("class","item_details_toggle fa fa-bullseye").on("click",function(e){this.parentNode.tipsy.hide(),t.browser.updateItemZoomText(e),t.browser.layout_infobox.attr("show","itemZoom")}).on("mouseover",function(){this.parentNode.tipsy.show()}).on("mouseout",function(){this.parentNode.tipsy.hide()})},hideListItemDetails:function(t){t.resultDOM.setAttribute("details",!1),t.showDetails=!1,sendLog&&sendLog(kshf.LOG.ITEM_DETAIL_OFF,{info:t.id()})},showListItemDetails:function(t){t.resultDOM.setAttribute("details",!0),t.showDetails=!0,this.detailCb&&this.detailCb.call(this,t),sendLog&&sendLog(kshf.LOG.ITEM_DETAIL_ON,{info:t.id()})},updateShowListGroupBorder:function(){if("list"===this.displayType)if(this.sortingOpt_Active.noGroupBorder===!0)this.dom.listItems.style("border-top-width","0px");
else{var t=null,e=this.sortingOpt_Active.value,i=this.sortingOpt_Active.func;this.browser.items.forEach(function(s){s.isWanted&&(null!==t&&void 0!==s.resultDOM&&(s.resultDOM.style.borderTopWidth=0!==i(e(s),e(t))?"4px":"0px"),t=s)})}},showMore:function(){this.maxVisibleItems*=2,this.updateItemVisibility(!0),this.dom.showMore.style("bottom","-27px"),sendLog&&sendLog(kshf.LOG.LIST_SHOWMORE,{info:this.maxVisibleItems})},reorderItemsOnDOM:function(){this.sortItems(),this.dom.listItems=this.dom.listItemGroup.selectAll("div.listItem").data(this.browser.items,function(t){return t.id()}).order()},sortItems:function(){var t=this.sortingOpt_Active.value,e=this.sortingOpt_Active.func,i=this.sortingOpt_Active.inverse;this.browser.items.sort(function(s,a){var r=t(s),n=t(a);if(void 0===r&&void 0!==n)return 1;if(void 0===n&&void 0!==r)return-1;if(void 0===n&&void 0===r)return 0;var o=e(r,n);return 0===o&&(o=a.id()-s.id()),i?-o:o})},getSortFunc:function(t){for(var e,i,s,a=0,s=0;!0;a++){if(3===s||a===this.browser.items.length){e=i;break}var r,n=this.browser.items[a],o=t(n);switch(typeof o){case"string":r=kshf.Util.sortFunc_List_String;break;case"number":r=kshf.Util.sortFunc_List_Number;break;case"object":r=o instanceof Date?kshf.Util.sortFunc_List_Date:kshf.Util.sortFunc_List_Number;break;default:r=kshf.Util.sortFunc_List_Number}r===i?s++:(i=r,s=0)}return e},updateItemVisibility:function(t){var e=this,i=0;this.dom.listItems.each(function(s){var a=this,r=s.wantedOrder>=0&&s.wantedOrder<e.maxVisibleItems;if(r&&i++,r&&e.visibleCb&&e.visibleCb.call(this,s),t)return this.style.display=r?"":"none",this.setAttribute("animSt","visible"),void 0;var n=s.wantedOrder>=0&&s.wantedOrder<50,o=s.wantedOrder_pre>=0&&s.wantedOrder_pre<50;n?o?(this.setAttribute("animSt","visible"),this.style.display=r?"":"none"):(this.style.display="",a.setAttribute("animSt","closed"),setTimeout(function(){a.setAttribute("animSt","open")},500),setTimeout(function(){a.setAttribute("animSt","visible")},1100+10*s.wantedOrder)):o&&r===!1?(setTimeout(function(){a.setAttribute("animSt","open")},10*-s.wantedOrder),setTimeout(function(){a.setAttribute("animSt","closed")},500),setTimeout(function(){a.style.display="none"},1e3)):(this.setAttribute("animSt","visible"),this.style.display=r?"":"none")});var s=this.browser.itemsSelectedCt-i;this.dom.showMore.style("display",0===s?"none":"block"),this.dom.showMore.select(".CountAbove").html("&#x25B2;"+i+" shown"),this.dom.showMore.select(".CountBelow").html(s+" below&#x25BC;")},updateContentWidth:function(t){t-=4,t-=this.browser.scrollWidth,this.dom.showMore.style("width",t-5+"px")},updateAfterFiltering_do:function(){this.updateVisibleIndex(),this.maxVisibleItems=kshf.maxVisibleItems_default,this.updateItemVisibility(!1)},updateAfterFilter:function(){var t=this,e=null,i=this.dom.listItemGroup[0][0],s=i.scrollTop,a=d3.ease("cubic-in-out"),r=1e3,n=function(o){var l;null===e&&(e=o),l=(o-e)/r,i.scrollTop=(1-a(l))*s,0===i.scrollTop?t.updateAfterFiltering_do():window.requestAnimationFrame(n)};window.requestAnimationFrame(n)},updateVisibleIndex:function(){var t=0,e=1;this.browser.items.forEach(function(i){i.wantedOrder_pre=i.wantedOrder,i.isWanted?(i.wantedOrder=t,t++):(i.wantedOrder=-e,e++)},this),this.showRank&&this.dom.ranks.text(function(t){return"#"+(t.wantedOrder+1)})}},kshf.Browser=function(t){var e=this;this.options=t,this.facets=[],this.facetsTop=[],this.facetsBottom=[],this.facetsLeft=[],this.facetsRight=[],this.linkedFacets=[],this.maxFilterID=0,this.barChartWidth=0,this.scrollWidth=21,this.sepWidth=10,this.line_height=18,this.filterList=[],this.pauseResultPreview=!1,this.resultPreviewActive=!1,this.previewCompareIsActive=!1,this.refreshPreviewTimeout=null,this.clearPreviewTimeout=null,this.columnsSkip=t.columnsSkip,this.categoryTextWidth=t.categoryTextWidth,void 0===this.categoryTextWidth&&(this.categoryTextWidth=115),this.rightPanelLabelWidth=this.categoryTextWidth,this.leftPanelLabelWidth=this.categoryTextWidth,t.leftPanelLabelWidth&&(this.leftPanelLabelWidth=t.leftPanelLabelWidth),t.rightPanelLabelWidth&&(this.rightPanelLabelWidth=t.rightPanelLabelWidth),"number"==typeof t.barChartWidth&&(this.barChartWidthInit=t.barChartWidth),this.subBrowser=t.subBrowser,this.facetDefs=t.facets,t.charts&&(this.facetDefs=t.charts),this.listDef=t.itemDisplay,t.list&&(this.listDef=t.list),this.listMaxColWidthMult=t.listMaxColWidthMult?t.listMaxColWidthMult:.25,this.domID=t.domID,this.source=t.source,this.source.loadedTableCount=0,this.loadedCb=t.loadedCb,this.readyCb=t.readyCb,this.updateCb=t.updateCb,this.previewCb=t.previewCb,this.previewCompareCb=t.previewCompareCb,this.dom={},this.itemName=void 0!==t.itemName?t.itemName:this.source.sheets[0].name,this.primItemCatValue=null,"string"==typeof t.catValue&&(this.primItemCatValue=t.catValue),this.showDataSource=!0,void 0!==t.showDataSource&&(this.showDataSource=t.showDataSource),this.forceHideBarAxis=!1,void 0!==t.forceHideBarAxis&&(this.forceHideBarAxis=t.forceHideBarAxis),this.TopRoot=d3.select(this.domID).classed("kshfHost",!0).style("position","relative").style("overflow-y","hidden").on("mousemove",function(){"object"==typeof logIf&&logIf.setSessionID()});for(var i=this.TopRoot[0][0];i.hasChildNodes();)i.removeChild(i.lastChild);this.root=this.TopRoot.attr("noanim",!1),t.showResizeCorner===!0&&this.insertResize(),this.insertInfobox(),this.layoutLeft=this.root.append("div").attr("class","kshf layout_left"),this.layoutRight=this.root.append("div").attr("class","kshf layout_right"),this.layoutList=this.root.append("div").attr("class","kshf listDiv"),this.layoutBottom=this.root.append("div").attr("class","kshf layout_bottom"),this.layoutLeft.on("mouseleave",function(){setTimeout(function(){e.updateLayout_Height()},1500)}),this.layoutRight.on("mouseleave",function(){setTimeout(function(){e.updateLayout_Height()},1500)}),this.layoutBottom.on("mouseleave",function(){setTimeout(function(){e.updateLayout_Height()},1500)}),window.setTimeout(function(){e.loadSource()},50)},kshf.Browser.prototype={getWidth_LeftPanel:function(){return this.leftPanelLabelWidth+this.getWidth_QueryPreview()+this.barChartWidth+this.scrollWidth},getWidth_RightPanel:function(){return this.rightPanelLabelWidth+this.getWidth_QueryPreview()+this.barChartWidth+this.scrollWidth},getWidth_Total:function(){return this.divWidth},getWidth_MidPanel:function(){var t=this.divWidth;return this.fullWidthResultSet()||(this.facetsLeft.length>0&&(t-=this.getWidth_LeftPanel()+2),this.facetsRight.length>0&&(t-=this.getWidth_RightPanel()+2)),t},domHeight:function(){return parseInt(this.TopRoot.style("height"))},domWidth:function(){return parseInt(this.TopRoot.style("width"))},createFilter:function(t){var e=new kshf.Filter(this.maxFilterID,t);return++this.maxFilterID,this.filterList.push(e),e},insertResize:function(){var t=this;this.root.append("div").attr("class","kshf layout_resize").on("mousedown",function(){t.root.style("cursor","nwse-resize"),t.root.attr("noanim",!0);var e=d3.mouse(d3.select("body")[0][0])[0],i=d3.mouse(d3.select("body")[0][0])[1],s=parseInt(d3.select(this.parentNode).style("width")),a=parseInt(d3.select(this.parentNode).style("height"));d3.select("body").on("mousemove",function(){var r=d3.mouse(d3.select("body")[0][0])[0]-e,n=d3.mouse(d3.select("body")[0][0])[1]-i;d3.select(t.domID).style("height",a+n+"px"),d3.select(t.domID).style("width",s+r+"px"),t.updateLayout()}).on("mouseup",function(){sendLog&&sendLog(kshf.LOG.RESIZE),t.root.style("cursor","default"),t.root.attr("noanim",!1),d3.select("body").on("mousemove",null).on("mouseup",null)}),d3.event.preventDefault()})},insertInfobox:function(){var t=this,e="";e+="<div align='center'>",e+="<div class='header'>This data browser is created by <span class='libName'>Keshif</span>.</div>",e+="<div align='center' class='boxinbox project_credits'>",e+="<div>Developed by</div>",e+=" <a href='http://www.cs.umd.edu/hcil/' target='_blank'><img src='https://wiki.umiacs.umd.edu/hcil/images/1/10/HCIL_logo_small_no_border.gif' style='height:50px'></a>",e+=" <a class='myName' href='http://www.adilyalcin.me' target='_blank'>M. Adil Yalçın</a>",e+=" <a href='http://www.umd.edu' target='_blank'><img src='http://www.trademarks.umd.edu/marks/gr/informal.gif' style='height:50px'></a>",e+="</div>",e+="",e+="<div align='center' class='boxinbox project_credits'>",e+="<div style='float:right; text-align: right'>",e+="<iframe src='http://ghbtns.com/github-btn.html?user=adilyalcin&repo=Keshif&type=watch&count=true' allowtransparency='true' frameborder='0' scrolling='0' width='90px' height='20px'></iframe><br/>",e+="</div>",e+="<div style='float:left; padding-left: 10px'>",e+="<iframe src='http://ghbtns.com/github-btn.html?user=adilyalcin&repo=Keshif&type=fork&count=true' allowtransparency='true' frameborder='0' scrolling='0' width='90px' height='20px'></iframe>",e+="</div>",e+=" 3rd party libraries and APIs:<br/>",e+=" <a href='http://d3js.org/' target='_blank'>D3</a> -",e+=" <a href='http://jquery.com' target='_blank'>JQuery</a> -",e+=" <a href='https://developers.google.com/chart/' target='_blank'>GoogleDocs</a>",e+="</div><br/>",e+="",e+="<div align='center' class='project_fund'>",e+="Keshif (<a target='_blank' href='http://translate.google.com/#auto/en/ke%C5%9Fif'><i>keşif</i></a>) means discovery / exploration in Turkish.<br/>",e+="Funded in part by <a href='http://www.huawei.com'>Huawei</a>. </div>",e+="",this.layout_infobox=this.root.append("div").attr("class","kshf layout_infobox").attr("show","loading"),this.layout_infobox.append("div").attr("class","background").on("click",function(){t.layout_infobox.attr("show","none")}),this.dom.loadingBox=this.layout_infobox.append("div").attr("class","infobox_content infobox_loading");var i=this.dom.loadingBox.append("span").attr("class","loadinggg");i.append("span").attr("class","loading_dots loading_dots_1").attr("anim",!0),i.append("span").attr("class","loading_dots loading_dots_2").attr("anim",!0),i.append("span").attr("class","loading_dots loading_dots_3").attr("anim",!0);var s=this.dom.loadingBox.append("div").attr("class","status_text");s.append("span").attr("class","status_text_sub info").text("Loading data sources..."),s.append("span").attr("class","status_text_sub dynamic").text(void 0!==this.source.sheets?"("+this.source.loadedTableCount+"/"+this.source.sheets.length+")":"");var a=this.layout_infobox.append("div").attr("class","infobox_content infobox_credit");a.append("div").attr("class","infobox_close_button").on("click",function(){t.layout_infobox.attr("show","none")}).append("span").attr("class","fa fa-times"),a.append("div").attr("class","all-the-credits").html(e),this.dom.infobox_itemZoom=this.layout_infobox.append("span").attr("class","infobox_content infobox_itemZoom"),this.dom.infobox_itemZoom.append("div").attr("class","infobox_close_button").on("click",function(){t.layout_infobox.attr("show","none")}).append("span").attr("class","fa fa-times"),this.dom.infobox_itemZoom_content=this.dom.infobox_itemZoom.append("span").attr("class","content")},updateItemZoomText:function(t){var e="";if(kshf.dt_ColNames[this.primaryTableName]){var i=kshf.dt_ColNames[this.primaryTableName];for(var s in i){var a=t.data[i[s]];null!==a&&void 0!==a&&(e+="<b>"+s+":</b> "+a.toString()+"<br>")}}else for(var s in t.data){var r=t.data[s];void 0!==r&&null!==r&&(e+="<b>"+s+":</b> "+r.toString()+"<br>")}this.dom.infobox_itemZoom_content.html(e)},insertClearAll:function(){var t=this;return void 0===this.listDisplay?(this.dom.filterClearAll=this.root.select(".ffffffff"),void 0):(this.dom.filterClearAll=this.listDisplay.dom.listHeader_TopRow.append("span").attr("class","filterClearAll").each(function(){this.tipsy=new Tipsy(this,{gravity:"n",title:function(){return"<span class='action'><span class='fa fa-times'></span> Remove</span> all filters"}})}).on("mouseenter",function(){this.tipsy.show(),d3.event.stopPropagation()}).on("mouseleave",function(){this.tipsy.hide(),d3.event.stopPropagation()}).on("click",function(){this.tipsy.hide(),t.clearFilters_All()}),this.dom.filterClearAll.append("span").attr("class","title").text("Clear"),this.dom.filterClearAll.append("div").attr("class","chartClearFilterButton allFilter").append("span").attr("class","fa fa-times"),void 0)},showInfoBox:function(){this.layout_infobox.attr("show","credit"),sendLog&&sendLog(kshf.LOG.INFOBOX)},loadSource:function(){this.source.sheets&&(this.source.sheets[0].primary=!0,this.primaryTableName=this.source.sheets[0].name,this.source.sheets.forEach(function(t){return void 0===t.id&&(t.id="id"),void 0===t.tableName&&(t.tableName=t.name),void 0!==kshf.dt[t.tableName]?(this.incrementLoadedSheetCount(),void 0):(this.source.gdocId?(void 0===this.source.url&&(this.source.url="https://docs.google.com/spreadsheet/ccc?key="+this.source.gdocId),this.loadSheet_Google(t)):this.source.dirPath?this.loadSheet_File(t):t.data&&this.loadSheet_Memory(t),void 0)},this)),this.source.callback&&this.source.callback(this)},loadSheet_Google:function(t){var e=this,i=1;t.headers&&(i=t.headers);var s=kshf.queryURL_base+this.source.gdocId+"&headers="+i;s+=t.sheetID?"&gid="+t.sheetID:"&sheet="+t.name,t.range&&(s+="&range="+t.range);var a=new google.visualization.Query(s);t.query&&a.setQuery(t.query),a.send(function(i){if(void 0!==kshf.dt[t.tableName])return e.incrementLoadedSheetCount(),void 0;if(i.isError())return e.layout_infobox.select("div.status_text .info").text("Cannot load data"),e.layout_infobox.select("span.loadinggg").selectAll("span").remove(),e.layout_infobox.select("span.loadinggg").append("i").attr("class","fa fa-warning"),e.layout_infobox.select("div.status_text .dynamic").text("("+i.getMessage()+")"),void 0;var s,a,r,n=[],o=-1,l=0,h=i.getDataTable(),c=h.getNumberOfColumns();for(r=0;!0;r++)if(r===c||h.getColumnLabel(r).trim()===t.id){o=r;break}for(n.length=h.getNumberOfRows(),a=0;a<h.getNumberOfRows();a++){var d=[];for(d.length=c,r=0;c>r;r++)d[r]=h.getValue(a,r);o===c&&d.push(l++),n[a]=new kshf.Item(d,o)}for(kshf.createColumnNames(t.tableName),s=0;s<h.getNumberOfColumns();s++)kshf.insertColumnName(t.tableName,h.getColumnLabel(s).trim(),s);o===c&&(kshf.dt_ColNames[t.tableName][t.id]=o,kshf.dt_ColNames_Arr[t.tableName][o]=t.id),e.finishDataLoad(t,n)})},loadSheet_File:function(t){var e=this,i=this.source.dirPath+t.name+"."+this.source.fileType;$.ajax({url:i,type:"GET",async:void 0===e.source.callback?!0:!1,contentType:"text/csv",success:function(i){if(void 0!==kshf.dt[t.tableName])return e.incrementLoadedSheetCount(),void 0;var s=[],a=t.id,r={};r.dynamicTyping=!0,r.header=!0,t.header===!1&&(r.header=!1),t.preview&&(r.preview=t.preview);var n=Papa.parse(i,r);n.data.forEach(function(t,e){void 0===t[a]&&(t[a]=e),s.push(new kshf.Item(t,a))}),e.finishDataLoad(t,s)}})},loadSheet_Memory:function(t){var e,i=[],s=-1,a=0;return void 0!==kshf.dt[t.tableName]?(this.incrementLoadedSheetCount(),void 0):(this.createColumnNames(t.tableName),t.data.forEach(function(r,n){0===n?(r.forEach(function(e,i){kshf.insertColumnName(t.tableName,e,i),e===t.id&&(s=i)}),-1===s&&(kshf.insertColumnName(t.tableName,t.id,e),s=e)):(s===r.length&&r.push(a++),i.push(new kshf.Item(r,s)))}),this.finishDataLoad(t,i),void 0)},createTableFromTable:function(t,e,i,s){var a=0;kshf.dt_id[e]={},kshf.dt[e]=[];var r=kshf.dt_id[e],n=kshf.dt[e];t.forEach(function(t){var e=i(t);if(""!==e&&void 0!==e&&null!==e)if(e instanceof Array)e.forEach(function(t){if(""!==t&&void 0!==t&&null!==t&&!r[t]){var e=[a++,t];s&&e.push(s(t));var i=new kshf.Item(e,0);r[t]=i,n.push(i)}});else if(!r[e]){var o=[a++,e];s&&o.push(s(v2));var l=new kshf.Item(o,0);r[e]=l,n.push(l)}})},finishDataLoad:function(t,e){kshf.dt[t.tableName]=e;var i={};e.forEach(function(t){i[t.id()]=t}),kshf.dt_id[t.tableName]=i,this.incrementLoadedSheetCount()},incrementLoadedSheetCount:function(){var t=this;this.source.loadedTableCount++,this.layout_infobox.select("div.status_text .dynamic").text("("+this.source.loadedTableCount+"/"+this.source.sheets.length+")"),void 0===this.source.callback&&this.source.loadedTableCount===this.source.sheets.length&&(this.source.sheets.forEach(function(t){t.primary&&(this.items=kshf.dt[t.tableName],this.itemsSelectedCt=this.items.length)},this),this.layout_infobox.select("div.status_text .info").text("Creating browser..."),this.layout_infobox.select("div.status_text .dynamic").text(""),window.setTimeout(function(){t.loadCharts()},50))},loadCharts:function(){var t=this;if(void 0!==this.loadedCb&&this.loadedCb.call(this),void 0===this.facetDefs){this.facetDefs=[];var e={};this.columnsSkip&&this.columnsSkip.forEach(function(t){e[t]=!0},this);var i=kshf.dt_ColNames_Arr[this.primaryTableName];i.forEach(function(t){t!==this.source.sheets[0].id&&e[t]!==!0&&"*"!==t[0]&&this.facetDefs.push({facetTitle:t})},this)}if(this.facetDefs.forEach(function(e){t.addFacet(e,this.primaryTableName)},this),this.facets.forEach(function(t){t.init_DOM()}),void 0!==this.listDef){this.listDisplay=new kshf.List(this,this.listDef,this.root);var s=this.listDisplay.dom.listHeader_TopRow.append("span").attr("class","resultInfo"),a=this.listDisplay.sortColWidth;this.dom.listheader_count=s.append("span").attr("class","listheader_count").style("width",a+"px").text(0!==this.itemsSelectedCt?this.itemsSelectedCt:"No"),s.append("span").attr("class","listheader_itemName").html(this.itemName),this.listDisplay.hideTextSearch!==!0&&this.listDisplay.insertGlobalTextSearch(),this.dom.filtercrumbs=this.listDisplay.dom.filtercrumbs;var r=this.listDisplay.dom.listHeader_TopRow.append("span").attr("class","rightBoxes");if(this.listDef.enableSave&&r.append("i").attr("class","fa fa-save ").each(function(){this.tipsy=new Tipsy(this,{gravity:"n",title:function(){return"Save results to Results facet"}})}).on("mouseover",function(){this.tipsy.show()}).on("mouseout",function(){this.tipsy.hide()}).on("click",function(){sendLog&&sendLog(kshf.LOG.DATASOURCE)}),this.showDataSource!==!1){var n=null;this.source.url?n=r.append("a").attr("class","fa fa-table datasource").attr("href",this.source.url).attr("target","_blank"):this.source.dirPath&&(n=r.append("i").attr("class","fa fa-table datasource")),n&&n.each(function(){this.tipsy=new Tipsy(this,{gravity:"n",title:function(){return"Open Data Source"}})}).on("mouseover",function(){this.tipsy.show()}).on("mouseout",function(){this.tipsy.hide()}).on("click",function(){sendLog&&sendLog(kshf.LOG.DATASOURCE)})}r.append("i").attr("class","fa fa-info-circle credits").each(function(){this.tipsy=new Tipsy(this,{gravity:"n",title:function(){return"Show Info & Credits"}})}).on("mouseover",function(){this.tipsy.show()}).on("mouseout",function(){this.tipsy.hide()}).on("click",function(){t.showInfoBox()})}this.insertClearAll(),this.loaded=!0,this.initBarChartWidth(),this.refreshFilterClearAll(),this.items.forEach(function(t){t.updateWanted()}),this.update(),this.updateLayout_Height(),this.layout_infobox.attr("show","none"),void 0!==this.readyCb&&this.readyCb(this)},addFacet:function(t,e){if(t.catTableName===this.primaryTableName&&(this.listDef.hasLinkedItems=!0),void 0===t.catItemMap)if(void 0!==kshf.dt_ColNames[e]){var i=this.getColumnID(e,t.facetTitle);void 0!==i&&(t.catItemMap=function(t){return t.data[i]})}else t.catItemMap=function(e){return e.data[t.facetTitle]};else"string"==typeof t.catItemMap&&(t.catItemMap=this.getColumnData(e,t.catItemMap));if(t.timeTitle&&(void 0===t.timeItemMap?t.timeItemMap=this.getColumnData(e,t.timeTitle):"string"==typeof t.timeItemMap&&(t.timeItemMap=this.getColumnData(e,t.timeItemMap))),void 0===t.items&&(t.items=this.items),t.type)t.type=t.type.toLowerCase();else if(t.catLabelText||t.timeTitle||t.catTableName)t.type="categorical";else if(t.intervalScale)t.type="interval";else if(void 0!==t.catItemMap){var s=t.catItemMap(kshf.dt[e][0]);t.type="number"==typeof s||s instanceof Date?"interval":"categorical"}else t.type="categorical";void 0===t.catBarScale&&(t.catBarScale=this.options.catBarScale);var a;switch("categorical"===t.type?(void 0!==t.timeTitle&&(t.layout="top"),a=this.addFacet_Categorical(t)):"interval"===t.type&&(a=this.addFacet_Interval(t)),t.layout){case"left":this.facetsLeft.push(a);break;case"right":this.facetsRight.push(a);break;case"top":this.facetsTop.push(a);break;case"bottom":this.facetsBottom.push(a);break;case"bottom-mid":this.layoutLeft.style("height","100%"),this.facetsBottom.push(a)}return a},addFacet_Categorical:function(t){void 0===t.layout&&(t.layout="left"),void 0===t.sortingOpts&&(t.sortingOpts=[{}]);var e=new kshf.Facet_Categorical(this,t);return this.facets.push(e),e.isLinked&&this.linkedFacets.push(e),e},addFacet_Interval:function(t){void 0===t.layout&&(t.layout="left");var e=new kshf.Facet_Interval(this,t);return this.facets.push(e),e},getColumnID:function(t,e){return void 0===kshf.dt_ColNames[t]?void 0:kshf.dt_ColNames[t][e]},getColumnData:function(t,e){var i=this.getColumnID(t,e);return void 0===i?function(t){return t.data[e]}:function(t){return t.data[i]}},mapItemData:function(t,e,i,s){t.forEach(function(t){var a=e(t);if(t.mappedDataCache[s]=null,void 0!==a&&""!==a&&null!==a){if(a instanceof Array){var r={};if(a=a.filter(function(t){return void 0===t||""===t||null===t?!1:void 0===r[t]?(r[t]=!0,!0):!1}),0===a.length)return}else a=[a];t.mappedDataCache[s]=[];var n=t.mappedDataCache[s];a.forEach(function(e){var s=i[e];void 0!=s&&(n.push(s),s.addItem(t))})}},this)},getWidth_QueryPreview:function(){if(this._labelXOffset)return this._labelXOffset;var t=d3.max(this.facets,function(t){return void 0===t.getMaxAggregate_Total?0:t.getMaxAggregate_Total()});this._labelXOffset=13;for(var e=1;t>9;)e++,t=Math.floor(t/10);return e>3&&(e=3,this._labelXOffset+=4),this._labelXOffset+=6*e,this._labelXOffset},filterFacetAttribute:function(t,e){this.facets[t].filterAttrib(this.facets[t]._attribs[e],"OR")},clearFilters_All:function(t){var e=this;this.filterList.forEach(function(t){t.clearFilter(!1,!1,!1)}),t!==!1&&(this.items.forEach(function(t){t.updateWanted_More(!0)}),this.updateItemSelectedCt(),this.refreshFilterClearAll(),this.update(1),sendLog&&sendLog(kshf.LOG.FILTER_CLEAR_ALL)),setTimeout(function(){e.updateLayout_Height()},1e3)},updateItemSelectedCt:function(){this.itemsSelectedCt=0,this.items.forEach(function(t){t.isWanted&&this.itemsSelectedCt++},this)},update:function(t){this.dom.listheader_count.text(0!==this.itemsSelectedCt?this.itemsSelectedCt:"No"),this.facets.forEach(function(e){e.updateAfterFilter(t)}),this.listDisplay&&this.listDisplay.updateAfterFilter(),this.updateCb&&this.updateCb(this)},refreshFilterClearAll:function(){var t=0;this.filterList.forEach(function(e){t+=e.isFiltered?1:0}),this.dom.filterClearAll.style("display",t>0?"inline-block":"none")},clearResultPreview:function(){var t=this;this.resultPreviewActive=!1,this.items.forEach(function(t){t.updatePreview_Cache=!1}),this.facets.forEach(function(t){t.clearResultPreview()}),window.clearTimeout(this.clearPreviewTimeout),window.clearTimeout(this.refreshPreviewTimeout),this.clearPreviewTimeout=window.setTimeout(function(){t.previewCompareIsActive=!1,t.facets.forEach(function(t){t.clearResultPreviewCompare()}),t.previewCompareCb&&t.previewCompareCb.call(this,!0)},1500),this.previewCb&&this.previewCb.call(this,!0)},refreshResultPreview:function(){var t=this;this.resultPreviewActive=!0,this.facets.forEach(function(t){t.refreshResultPreview()}),window.clearTimeout(this.clearPreviewTimeout),window.clearTimeout(this.refreshPreviewTimeout),this.previewCompareIsActive===!1&&(this.refreshPreviewTimeout=window.setTimeout(function(){t.facets.forEach(function(t){t.refreshResultPreviewCompare()}),t.previewCompareIsActive=!0,t.previewCompareCb&&t.previewCompareCb.call(this,!1)},2500)),this.previewCb&&this.previewCb.call(this,!1)},updateLayout:function(){this.loaded===!0&&(this.divWidth=this.domWidth(),this.updateLayout_Height(),this.setBarWidthLeftPanel(this.barChartWidth))},updateLayout_Height:function(){var t=this,e=this.domHeight(),i=e,s=!1,a=!1;this.facets.forEach(function(t){t.heightProcessed=!1});var r=0;if(this.facetsBottom.length>0){var n=i/5;this.facetsBottom.forEach(function(t){t.setHeight(n),t.heightProcessed=!0,r=Math.max(r,t.getHeight()),"bottom"===t.options.layout&&(s=!0,a=!0)})}var o=function(e,i){var s=!1,a=0,r=!1;for(i.forEach(function(t){t.heightProcessed&&a++});;){var n=i.length-a;if(0===n&&10>e)break;var o=a;if(i.forEach(function(i){if(r===!0&&e>5&&!i.collapsed&&void 0!==i.attribCount_Total&&i.attribCount_InDisplay<i.attribCount_Total)return e+=i.getHeight(),i.setHeight(e),e-=i.getHeight(),void 0;if(!i.heightProcessed&&0!==n){var o=Math.floor(e/n);if(s&&o<i.getHeight_RangeMin()&&i.setCollapsed(!0),!i.collapsed)if(i.options.catDispCountFix){var l=i.getHeight_Header()+(i.options.catDispCountFix+1)*t.line_height;if(!s)return;l=Math.max(l,o),i.setHeight(l)}else if(i.getHeight_RangeMax()<=o)i.setHeight(i.getHeight_RangeMax());else if(s)i.setHeight(o);else if(!r)return;e-=i.getHeight(),i.heightProcessed=!0,a++,n--}},this),s=o===a,r===!0)break;0===n&&(r=!0)}return e},l=e;if(this.facetsLeft.length>0){var h=i;s&&(h-=r);var c=o(h,this.facetsLeft);l-=c}if(this.facetsRight.length>0){var d=i;a&&(d-=r),o(d,this.facetsRight)}if(this.facets.forEach(function(t){t.refreshHeight()}),this.listDisplay){var u=0;this.fullWidthResultSet();var f=this.listDisplay.dom.listHeader[0][0].offsetHeight,n=e-u-f;this.facetsBottom.length>0&&(n-=this.facetsBottom[0].getHeight()),this.listDisplay.dom.listItemGroup.style("height",n+"px")}},initBarChartWidth:function(){this.divWidth=this.domWidth();var t;if(this.fullWidthResultSet()&&this.isSmallWidth())t=this.divWidth-this.getWidth_Label()-this.browser.getWidth_QueryPreview()-this.scrollWidth;else if(t=this.barChartWidthInit,void 0===t){var e=this.divWidth-this.categoryTextWidth;this.facetsRight.length>0,e-=this.categoryTextWidth,t=Math.floor(e/10)}this.setBarWidthLeftPanel(t)},setBarWidthLeftPanel:function(t){if(t>200?(this.hideBars=!1,this.hideBarAxis=!1):t>45?(this.hideBars=!1,this.hideBarAxis=!1):t>10?(this.hideBars=!1,this.hideBarAxis=!0):(this.hideBars=!0,this.hideBarAxis=!0,t=0),this.forceHideBarAxis===!0&&(this.hideBarAxis=!0),this.hideBars===!1?this.root.attr("hidebars",!1):this.root.attr("hidebars",!0),this.hideBarAxis===!1?this.root.attr("hideBarAxis",!1):this.root.attr("hideBarAxis",!0),this.barChartWidth=t,this.facets.forEach(function(t){t.hasAttribs&&t.hasAttribs()&&t.updateBarPreviewScale2Active(),t.refreshWidth()},this),this.listDisplay){var e=this.divWidth,i=0,s=0;this.fullWidthResultSet()||(this.facetsLeft.length>0&&(i=2,e-=this.getWidth_LeftPanel()+2),this.facetsRight.length>0&&(s=2,e-=this.getWidth_RightPanel()+2)),this.listDisplay.updateContentWidth(e),this.listDisplay.listDiv.style("width",e+"px"),this.layoutLeft.style("margin-right",i+"px"),this.layoutRight.style("margin-left",s+"px")}},isSmallWidth:function(){return this.leftPanelLabelWidth+260>this.divWidth},fullWidthResultSet:function(){return 0==this.facetsLeft.length&&0==this.facetsRight.length?!0:this.isSmallWidth()?!0:!1},getFilterState:function(){var t={resultCt:this.itemsSelectedCt};return t.filtered="",t.selected="",this.filterList.forEach(function(e){e.isFiltered&&(""!==t.filtered&&(t.filtered+="x"),t.filtered+=e.id,""!==t.selected&&(t.selected+="x"))},this),""===t.filtered&&(t.filtered=void 0),""===t.selected&&(t.selected=void 0),t},getFilterSummary:function(){var t="";return this.filterList.forEach(function(e,i){e.isFiltered&&e.summary_item_cb&&(0!=i&&(t+=" & "),e.summary_header&&(t+=e.summary_header+": "),t+=e.summary_item_cb())},this),t}},kshf.Facet_Categorical=function(t,e){this.id=++kshf.num_of_charts,this.browser=t,this.filteredItems=e.items,this.options=e,this.layoutStr=e.layout,this.sortingOpts=e.sortingOpts.slice(),this.parentFacet=e.parentFacet,this.dom={},this.scrollTop_cache=0,this.attrib_InDisplay_First=0,this.configRowCount=0,this.subFacets=[],this.collapsed=!1,e.collapsed===!0&&(this.collapsed=!0),this.skipSorting=!1,this.hasAttribs()&&this.initAttribs(e)},kshf.Facet_Categorical.prototype={hasEntityParent:function(){return void 0!==this.parentFacet?this.parentFacet.hasAttribs():void 0},getAttribs:function(){return kshf.dt[this.catTableName]},getAttribs_wID:function(){return kshf.dt_id[this.catTableName]},getWidth:function(){return"left"===this.options.layout?this.browser.getWidth_LeftPanel()-this.getWidth_LeftOffset():"right"===this.options.layout?this.browser.getWidth_RightPanel()-this.getWidth_LeftOffset():void 0},getWidth_Header:function(){return"left"===this.options.layout?this.browser.getWidth_LeftPanel()-(void 0!==this.parentFacet?this.getWidth_LeftOffset():0):"right"===this.options.layout?this.browser.getWidth_RightPanel()-(void 0!==this.parentFacet?this.getWidth_LeftOffset():0):void 0},getWidth_Label:function(){var t=0;return"left"===this.options.layout&&(t=this.browser.leftPanelLabelWidth),"right"===this.options.layout&&(t=this.browser.rightPanelLabelWidth),t-=this.getWidth_LeftOffset()},getHeight_Header:function(){return void 0==this._height_header&&(this._height_header=this.dom.headerGroup[0][0].offsetHeight,this.hasFacets()&&(this._height_header+=2)),this._height_header},getHeight_RangeMax:function(){return this.hasAttribs()?this.getHeight_Header()+(this.configRowCount+this.attribCount_Visible+1)*this.browser.line_height-1:this.browser.line_height},getHeight_RangeMin:function(){return this.hasAttribs()?this.getHeight_Header()+(this.configRowCount+Math.min(this.attribCount_Visible,3)+1)*this.browser.line_height:this.browser.line_height},getHeight:function(){return this.hasAttribs()?this.collapsed?this.getHeight_Header()-2:this.getHeight_Header()+this.getHeight_Content()-2:this.getHeight_Header()-2},getHeight_Content:function(){var t=this.attribHeight+this.browser.line_height*this.configRowCount;return this.areAllAttribsInDisplay()&&this.browser.hideBarAxis||(t+=17),t},getWidth_LeftOffset:function(){var t=0;return this.parentFacet?t+=17:this.hasFacets()&&(t+=17),t},isFiltered:function(){return this.attribFilter.isFiltered},areAllAttribsInDisplay:function(){return this.attribCount_Visible===this.attribCount_InDisplay},hasFacets:function(){return this.subFacets.length>0},hasAttribs:function(){return this._attribs&&0===this._attribs.length?!1:void 0!==this.options.catItemMap},initAttribs:function(t){var e=this;if(this.sortingOpts.forEach(function(t){void 0===t.no_resort&&(t.no_resort=!1),void 0===t.func?t.func=kshf.Util.sortFunc_aggreage_Active_Total:t.custom=!0,void 0===t.inverse&&(t.inverse=!1)},this),this.sortingOpt_Active=this.sortingOpts[0],void 0===this.options.showNoneCat&&(this.options.showNoneCat=!1),void 0===this.options.removeInactiveAttrib&&(this.options.removeInactiveAttrib=!0),void 0===this.options.catLabelText&&(this.options.catLabelText=function(t){return t.data[1]}),void 0===this.options.catTableName?(this.catTableName=this.options.facetTitle+"_h_"+this.id,this.browser.createTableFromTable(this.filteredItems,this.catTableName,this.options.catItemMap,this.options.attribNameFunc)):(this.options.catTableName===this.browser.primaryTableName&&(this.isLinked=!0,this.options.catTableName=this.options.facetTitle+"_h_"+this.id,kshf.dt_id[this.options.catTableName]=kshf.dt_id[this.browser.primaryTableName],kshf.dt[this.options.catTableName]=this.filteredItems.slice()),this.catTableName=this.options.catTableName),void 0===this.isLinked&&(this.isLinked=!1),this.options.showNoneCat===!0){var i=1e4,s=new kshf.Item([i,"None"],0);this.getAttribs().push(s),this.getAttribs_wID()[i]=s;var a=this.options.catItemMap;this.options.catItemMap=function(t){var e=a(t);return null===e?i:void 0===e?i:e instanceof Array&&0===e.length?i:e};var r=this.options.catLabelText;if(this.options.catLabelText=function(t){return t.id()===i?"None":r(t)},this.options.catTooltipText){var n=this.options.catTooltipText;this.options.catTooltipText=function(t){return t.id()===i?"None":n(t)}}}this.attribFilter=this.browser.createFilter({name:this.options.facetTitle,browser:this.browser,filteredItems:this.filteredItems,facet:this,onClear:function(){this.clearLabelTextSearch(),this.unselectAllAttribs(),this._update_Selected()
},onFilter:function(t){this._update_Selected();var e=t.id;this.filteredItems.forEach(function(i){var s=i.mappedDataCache[e];if(null===s)return t.selected_AND.length>0||t.selected_OR.length>0?(i.setFilterCache(e,!1),void 0):(i.setFilterCache(e,!0),void 0);if(t.selected_NOT.length>0&&!s.every(function(t){return!t.is_NOT()}))return i.setFilterCache(e,!1),void 0;if(t.selected_OR.length>0&&s.some(function(t){return t.is_OR()}))return i.setFilterCache(e,!0),void 0;if(t.selected_AND.length>0){var a=0;return s.forEach(function(t){t.is_AND()&&a++}),a!==t.selected_AND.length?(i.setFilterCache(e,!1),void 0):(i.setFilterCache(e,!0),void 0)}return t.selected_OR.length>0?(i.setFilterCache(e,!1),void 0):(i.setFilterCache(e,!0),void 0)},this)},summary_header:this.options.summaryHeader?this.options.summaryHeader:this.options.facetTitle,summary_item_cb:function(){var t="",i=e.options.catLabelText;e.options.catTooltipText;var s=this.selectedCount_Total();if(this.facet.subFacets.some(function(t){return t.isFiltered()}))return" <i class='fa fa-hand-o-right'></i>";var a=" <span class='AndOrNot AndOrNot_And'>And</span> ",r=" <span class='AndOrNot AndOrNot_Or'>Or</span> ",n=" <span class='AndOrNot AndOrNot_Not'>Not</span> ";if(s>4||this.linkFilterSummary)t="<b>"+s+"</b> selected";else{var o=0;(this.selected_AND.length>0||this.selected_OR.length>0)&&(this.selected_NOT.length>0&&(t+="[ "),e.attribFilter.selected_AND.forEach(function(e,s){t+=(0!==s?a:"")+"<span class='attribName'>"+i(e)+"</span>",o++}),e.attribFilter.selected_OR.forEach(function(e,s){t+=(0!==s||o>0?r:"")+"<span class='attribName'>"+i(e)+"</span>",o++}),this.selected_NOT.length>0&&(t+=" ]")),e.attribFilter.selected_NOT.forEach(function(e){t+=(0!==o?a:"")+n+"<span class='attribName'>"+i(e)+"</span>",o++})}return this.linkFilterSummary&&(t+="<i class='fa fa-hand-o-left'></i><br> ["+this.linkFilterSummary+"]"),t}}),this.attribFilter.selected_AND=[],this.attribFilter.selected_OR=[],this.attribFilter.selected_NOT=[],this.attribFilter.selectedCount_Total=function(){return this.selected_AND.length+this.selected_OR.length+this.selected_NOT.length},this.attribFilter.selected_Any=function(){return this.selected_AND.length>0||this.selected_OR.length>0||this.selected_NOT.length>0},this.attribFilter.selected_All_clear=function(){kshf.Util.clearArray(this.selected_AND),kshf.Util.clearArray(this.selected_OR),kshf.Util.clearArray(this.selected_NOT)},this.attribFilter.saveFilter=function(){var t=new kshf.Item([e._attribs.length+1,this.summary_item_cb()],0);this.filteredItems.forEach(function(e){e.isWanted&&(t.addItem(e),e.mappedDataCache[this.id].push(t))},this),t.items.length>0&&(e._attribs.push(t),e.insertAttribs(),e.updateAttribCount_Total(),e.refreshLabelWidth(),e.updateSorting(0,!0)),this.clearFilter()},this.facetFilter=this.attribFilter,this.mapAttribs(t)},getGroupText:function(){return this.isLinked?this.browser.itemName:this.options.facetTitle},insertSubFacets:function(){this.dom.subFacets=this.divRoot.append("div").attr("class","subFacets"),this.dom.subFacets.append("span").attr("class","facetGroupBar").append("span").attr("class","facetGroupBarSub"),this.hasAttribs()?this.options.facets.forEach(function(t){t.parentFacet=this,t.layout=this.layoutStr,t.items=this._attribs;var e=this.browser.addFacet(t,this.catTableName);this.subFacets.push(e)},this):this.options.facets.forEach(function(t){t.parentFacet=this,t.layout=this.layoutStr;var e=this.browser.addFacet(t,this.browser.primaryTableName);this.subFacets.push(e)},this),this.subFacets.forEach(function(t){t.init_DOM()})},mapAttribs:function(t){var e=this.attribFilter.id;this.browser.mapItemData(this.filteredItems,this.options.catItemMap,this.getAttribs_wID(),e),this.hasMultiValueItem=!1,this.filteredItems.forEach(function(t){var i=t.mappedDataCache[e];null!==i&&i.length>1&&(this.hasMultiValueItem=!0)},this),this._dataMap=this.options.dataMap?this.isLinked?function(e){return t.dataMap(e)}:function(e){return 0===e.items.length?null:t.dataMap(e)}:this.isLinked?function(t){return t.id()}:function(t){return 0===t.items.length?null:t.id()},this._attribs=this.getAttribs().filter(function(t){return null!==this._dataMap(t)},this),this.updateAttribCount_Total(),this.updateAttribCount_Visible(),1===this.attribCount_Visible&&(this.options.catBarScale="scale_frequency"),this.unselectAllAttribs()},updateAttribCount_Total:function(){this.attribCount_Total=this._attribs.length,this.attribCount_Wanted=this.attribCount_Total,this.showTextSearch=this.options.forceSearch||this.options.forceSearch!==!1&&this.attribCount_Total>=20},updateAttribCount_Wanted:function(){this.attribCount_Wanted=0,this._attribs.forEach(function(t){t.isWanted&&this.attribCount_Wanted++},this)},updateAttribCount_Visible:function(){this.attribCount_Visible=0,this.attribCount_NowVisible=0,this.attribCount_NowInvisible=0,this._attribs.forEach(function(t){v=this.isAttribVisible(t),t.isVisible_before=t.isVisible,t.isVisible=v,!t.isVisible&&t.isVisible_before&&this.attribCount_NowInvisible++,t.isVisible&&!t.isVisible_before&&this.attribCount_NowVisible++,t.isVisible&&this.attribCount_Visible++},this)},init_DOM:function(){var t,e=this;if(this.parentFacet)t=this.parentFacet.dom.subFacets;else switch(this.options.layout){case"left":t=this.browser.layoutLeft;break;case"right":t=this.browser.layoutRight;break;case"bottom":t=this.browser.layoutBottom}this.divRoot=t.append("div").attr("class","kshfChart").attr("collapsed",this.collapsed===!1?"false":"true").attr("filtered",!1).attr("removeInactiveAttrib",this.options.removeInactiveAttrib).attr("filtered_or",0).attr("filtered_and",0).attr("filtered_not",0).attr("filtered_total",0).attr("hasMultiValueItem",this.hasMultiValueItem).on("mouseleave",function(){e.skipSorting&&e.hasAttribs()&&(e.skipSorting=!1,setTimeout(function(){e.updateSorting(0)},750))}),kshf.Util.insertHeader.call(this),this.hasAttribs()&&this.init_DOM_Attrib(),this.options.facets&&(this.divRoot.attr("hasFacets",!0),this.insertSubFacets(),this.refreshLabelWidth())},init_DOM_Attrib:function(){var t=this;this.dom.wrapper=this.divRoot.append("div").attr("class","wrapper"),this.options.facets&&this.dom.wrapper.append("span").attr("class","facetGroupBar"),this.dom.facetCategorical=this.dom.wrapper.append("div").attr("class","facetCategorical"),this.options.facets&&this.dom.facetCategorical.style("margin-left","17px"),(this.showTextSearch||this.sortingOpts.length>1)&&(this.dom.facetControls=this.dom.facetCategorical.append("div").attr("class","facetControls"),this.showTextSearch&&(this.insertLabelTextSearch(),this.configRowCount++),this.sortingOpts.length>1&&(this.insertSortingOpts(),this.configRowCount++)),this.dom.scrollToTop=this.dom.facetCategorical.append("div").attr("class","scrollToTop fa fa-arrow-up").attr("title","Scroll To Top").on("click",function(){kshf.Util.scrollToPos_do(t.dom.attribGroup[0][0],0),sendLog&&sendLog(kshf.LOG.FACET_SCROLL_TOP,{id:t.id})}),this.dom.attribGroup=this.dom.facetCategorical.append("div").attr("class","attribGroup").on("scroll",function(){kshf.Util.ignoreScrollEvents!==!0&&(t.dom.scrollToTop.style("visibility",this.scrollTop>0?"visible":"hidden"),t.scrollTop_cache=this.scrollTop,t.attrib_InDisplay_First=Math.floor(this.scrollTop/(1*t.browser.line_height)),t.refreshScrollDisplayMore(t.attrib_InDisplay_First+t.attribCount_InDisplay),t.cullAttribs(),t.browser.pauseResultPreview=!0,this.pauseTimer&&clearTimeout(this.pauseTimer),this.pauseTimer=setTimeout(function(){t.browser.pauseResultPreview=!1},200))}),this.dom.belowAttribs=this.dom.facetCategorical.append("div").attr("class","belowAttribs"),this.dom.belowAttribs.append("div").attr("class","border_line"),this.dom.barChartPreviewAxis=this.dom.belowAttribs.append("div").attr("class","barChartPreviewAxis"),this.dom.attribGroupFiller=this.dom.attribGroup.append("span").attr("class","filler");var e=this.dom.belowAttribs.append("div").attr("class","hasLabelWidth");this.dom.scroll_display_more=e.append("span").attr("class","scroll_display_more").on("mousedown",function(){kshf.Util.scrollToPos_do(t.dom.attribGroup[0][0],t.dom.attribGroup[0][0].scrollTop+18),sendLog&&sendLog(kshf.LOG.FACET_SCROLL_MORE,{id:t.id})}),this.insertAttribs(),this.refreshLabelWidth(),this.updateSorting(0,!0)},selectAllAttribsButton:function(){this._attribs.forEach(function(t){t.selectedForLink&&t.set_OR(this.attribFilter.selected_OR)},this),this._update_Selected(),this.attribFilter.how="All",this.attribFilter.addFilter(!0),sendLog&&sendLog(kshf.LOG.FILTER_ATTR_ADD_OR_ALL,{id:this.attribFilter.id})},getMaxAggregate_Active:function(){return d3.max(this._attribs,function(t){return t.aggregate_Active})},getMaxAggregate_Total:function(){return this.hasAttribs()?this._maxBarValueMaxPerAttrib?this._maxBarValueMaxPerAttrib:(this._maxBarValueMaxPerAttrib=d3.max(this._attribs,function(t){return t.aggregate_Total}),this._maxBarValueMaxPerAttrib):0},_update_Selected:function(){this.divRoot&&this.divRoot.attr("filtered",this.isFiltered()).attr("filtered_or",this.attribFilter.selected_OR.length).attr("filtered_and",this.attribFilter.selected_AND.length).attr("filtered_not",this.attribFilter.selected_NOT.length).attr("filtered_total",this.attribFilter.selectedCount_Total());var t=this.attribFilter.selected_OR.length+this.attribFilter.selected_AND.length>1;this.attribFilter.selected_OR.forEach(function(e){e.facetDOM.setAttribute("show-box",t)},this),this.attribFilter.selected_AND.forEach(function(e){e.facetDOM.setAttribute("show-box",t)},this),this.attribFilter.selected_NOT.forEach(function(t){t.facetDOM.setAttribute("show-box","true")},this)},unselectAllAttribs:function(){this._attribs.forEach(function(t){t.f_selected()&&t.facetDOM&&t.facetDOM.setAttribute("highlight",!1),t.set_NONE()}),this.attribFilter.selected_All_clear()},setCollapsed:function(t){this.collapsed=t,this.divRoot.attr("collapsed",this.collapsed===!1?"false":"true"),this.hasFacets()&&!this.hasAttribs()&&this.subFacets.forEach(function(e){e.setCollapsed(t)})},collapseFacet:function(t){this.setCollapsed(t),this.browser.updateLayout_Height(),sendLog&&sendLog(t===!0?kshf.LOG.FACET_COLLAPSE:kshf.LOG.FACET_SHOW,{id:this.id})},insertLabelTextSearch:function(){var t=this,e=this.dom.facetControls.append("div").attr("class","attribTextSearch hasLabelWidth");this.dom.attribTextSearch=e.append("input").attr("class","attribTextSearchInput").attr("type","text").attr("placeholder","Search").on("input",function(){this.timer&&clearTimeout(this.timer);var i=this;this.timer=setTimeout(function(){var s=i.value.toLowerCase();""===s?t.attribFilter.clearFilter():(e.select(".clearText").style("display","block"),t.attribFilter.selected_All_clear(),t._attribs.forEach(function(e){-1!==t.options.catLabelText(e).toString().toLowerCase().indexOf(s)?e.set_OR(t.attribFilter.selected_OR):t.options.catTooltipText&&-1!==t.options.catTooltipText(e).toLowerCase().indexOf(s)?e.set_OR(t.attribFilter.selected_OR):e.set_NONE()}),0===t.attribFilter.selectedCount_Total()?t.attribFilter.clearFilter():(t.attribFilter.how="All",t.attribFilter.addFilter(!0),t.attribFilter.linkFilterSummary="",sendLog&&sendLog(kshf.LOG.FILTER_TEXTSEARCH,{id:t.attribFilter.id,info:s})))},750)}).on("blur",function(){d3.event.stopPropagation(),d3.event.preventDefault()}),e.append("i").attr("class","fa fa-search searchIcon"),this.dom.clearTextSearch=e.append("i").attr("class","fa fa-times-circle clearText").on("click",function(){t.attribFilter.clearFilter()})},clearLabelTextSearch:function(){this.showTextSearch&&(this.dom.clearTextSearch.style("display","none"),this.dom.attribTextSearch[0][0].value="")},insertSortingOpts:function(){var t=this,e=this.dom.facetControls.append("span").attr("class","sortOptionSelectGroup hasLabelWidth");e.append("select").attr("class","optionSelect").attr("dir","rtl").on("change",function(){t.sortingOpt_Active=t.sortingOpts[this.selectedIndex],t.dom.sortInverse.attr("inverse",t.sortingOpt_Active.inverse),t.updateSorting_do.call(t,0),sendLog&&sendLog(kshf.LOG.FACET_SORT,{id:t.id,info:this.selectedIndex})}).selectAll("input.sort_label").data(this.sortingOpts).enter().append("option").attr("class","sort_label").text(function(t){return t.name}),this.dom.sortInverse=e.append("span").attr("class","sortIcon fa").on("click",function(){t.sortingOpt_Active.inverse=t.sortingOpt_Active.inverse?!1:!0,this.setAttribute("inverse",t.sortingOpt_Active.inverse),t.updateSorting_do.call(t,0)}).each(function(){this.tipsy=new Tipsy(this,{gravity:"w",title:function(){return"Reverse order"}})}).on("mouseover",function(){this.tipsy.show()}).on("mouseout",function(){this.tipsy.hide()})},updateBarPreviewScale2Active:function(){if(this.hasAttribs()){var t=this;this.chartPreviewAxisScale=d3.scale.linear().rangeRound([0,this.browser.barChartWidth]).nice(this.getTicksSkip()).clamp(!0),"scale_frequency"===this.options.catBarScale?this.chartPreviewAxisScale.domain([0,this.browser.itemsSelectedCt]):this.chartPreviewAxisScale.domain([0,this.getMaxAggregate_Active()]),this.refreshWidth_Bars_Active(),this.refreshWidth_Bars_Total(),this.dom.bars_preview.attr("fast",null),this.refreshResultPreview(),setTimeout(function(){t.dom.bars_preview.attr("fast",!0)},700),this.refreshChartPreviewAxis()}},setHeight:function(t){if(this.hasAttribs()){this.attribHeight=Math.min(t-this.getHeight_Header()-(1+this.configRowCount)*this.browser.line_height+1,this.browser.line_height*this.attribCount_Visible);var e=Math.floor(this.attribHeight/this.browser.line_height);0>e&&(e=1),e>this.attribCount_Visible&&(e=this.attribCount_Visible),e=this.attribCount_Visible<=2?this.attribCount_Visible:Math.max(e,2),this.attribCount_InDisplay=e,this.refreshScrollDisplayMore(this.attribCount_InDisplay),this.cullAttribs()}},updateAfterFilter:function(){this.hasAttribs()&&(this.refreshQueryPreview(!0),this.updateBarPreviewScale2Active(),this.skipSorting?this.refreshWidth_Bars_Active():this.updateSorting())},refreshWidth:function(){this.dom.facetCategorical&&this.dom.facetCategorical.style("width",this.getWidth()+"px")},refreshQueryPreview:function(t){var e=this,i=kshf.Util.formatForItemCount;this.dom.attribs.attr("noitems",function(t){return!e.isAttribSelectable(t)}),this.dom.item_count.each(function(s){if(!s.isCulled||t===!0){var a=s.aggregate_Preview;a=e.browser.resultPreviewActive?e.browser.preview_not?s.aggregate_Active-s.aggregate_Preview:s.aggregate_Preview:s.aggregate_Active,s.cache_querypreview!==a&&(s.cache_querypreview=a,this.textContent=i(a))}})},refreshWidth_Bars_Active:function(){var t=this;this.dom.bars_active.each(function(e){kshf.Util.setTransform(this,"scaleX("+t.chartPreviewAxisScale(e.aggregate_Active)+")")});var e=this.getWidth_Label()+this.browser.getWidth_QueryPreview();this.dom.attribClickArea.style("width",function(i){return e+t.chartPreviewAxisScale(i.aggregate_Active)+"px"})},refreshWidth_Bars_Total:function(){var t=this;this.dom.bars_total.each(function(e){kshf.Util.setTransform(this,"scaleX("+t.chartPreviewAxisScale(e.aggregate_Total)+")")})},clearResultPreviewCompare:function(){this.hasAttribs()&&this.dom.bars_preview_compare.each(function(){this.setAttribute("hidden",!0)})},refreshResultPreviewCompare:function(){var t=this;this.dom.bars_preview_compare.each(function(e){kshf.Util.setTransform(this,"translateX("+t.chartPreviewAxisScale(e.cache_preview)+"px)"),this.setAttribute("hidden",0===e.cache_preview)})},clearResultPreview:function(t){this.hasAttribs()&&(this._attribs.forEach(function(t){t.updatePreview_Cache=!1}),this.collapsed||(this.dom.bars_preview.each(function(e){e.aggregate_Preview=0,e.isCulled&&t!==!0||0!==e.cache_preview&&kshf.Util.setTransform(this,"scaleX(0)")}),this.refreshQueryPreview()))},refreshResultPreview:function(t){var e=this;this.hasAttribs()&&(this.collapsed||(this.dom.bars_preview.each(function(i){if(!i.isCulled||t===!0){var s=i.aggregate_Preview;e.browser.preview_not&&(s=i.aggregate_Active-s),i.cache_preview=s,kshf.Util.setTransform(this,"scaleX("+e.chartPreviewAxisScale(s)+")")}}),this.refreshQueryPreview()))},refreshLabelWidth:function(){if(this.hasAttribs()){var t=this.browser,e=this.getWidth_Label();this.dom.facetCategorical.selectAll(".hasLabelWidth").style("width",e+"px"),this.dom.barChartPreviewAxis.each(function(){kshf.Util.setTransform(this,"translateX("+(e+t.getWidth_QueryPreview())+"px)")})}},refreshScrollDisplayMore:function(t){var e="",i=this.attribCount_Visible-t-1;i>0&&(e=" / "+i+" below..."),this.dom.scroll_display_more.text(this.attribCount_Visible+" total"+e)},refreshHeight:function(){if(this.hasAttribs()){this.dom.wrapper.style("height",(this.collapsed?"0":this.getHeight_Content())+"px"),this.dom.attribGroup.style("height",this.attribHeight+"px");var t=this.attribHeight-8;this.dom.barChartPreviewAxis.selectAll("span.line").style("top",-t+"px").style("height",t+"px")}},isAttribVisible:function(t){return this.isLinked?t.selectedForLink===!1?!1:!0:t.f_selected()?!0:0!==t.aggregate_Active?!0:this.attribCount_Wanted<this.attribCount_Total&&t.isWanted?!0:this.options.removeInactiveAttrib===!1?!0:this.isFiltered()?t.isWanted===!1?!1:!0:0!==t.aggregate_Active},isAttribSelectable:function(t){return t.f_selected()?!0:0!==t.aggregate_Active?!0:this.isFiltered()&&!this.hasMultiValueItem?!0:!1},filterAttrib:function(t,e,i){this.skipSorting=!0;var s=this.attribFilter.selected_OR.length>0&&(this.attribFilter.selected_AND.length>0||this.attribFilter.selected_NOT.length>0);if("NOT"===e&&t.is_NOT()&&(e="NONE"),"AND"===e&&t.is_AND()&&(e="NONE"),"OR"===e&&t.is_OR()&&(e="NONE"),"NONE"===e&&((t.is_AND()||t.is_NOT())&&(this.attribFilter.how="MoreResults"),t.is_OR()&&(this.attribFilter.how=0===this.attribFilter.selected_OR.length?"MoreResults":"LessResults"),t.set_NONE(),sendLog&&sendLog(kshf.LOG.FILTER_ATTR_UNSELECT,{id:this.attribFilter.id,info:t.id()})),"NOT"===e){if(t.is_NONE()){if(t.aggregate_Active===this.browser.itemsSelectedCt)return alert("Removing this attribute would make an empty result set, so it is not allowed."),void 0;this.attribFilter.how="LessResults"}else this.attribFilter.how="All";t.set_NOT(this.attribFilter.selected_NOT),sendLog&&sendLog(kshf.LOG.FILTER_ATTR_ADD_NOT,{id:this.attribFilter.id,info:t.id()})}if("AND"===e&&(t.set_AND(this.attribFilter.selected_AND),this.attribFilter.how="LessResults",sendLog&&sendLog(kshf.LOG.FILTER_ATTR_ADD_AND,{id:this.attribFilter.id,info:t.id()})),"OR"===e){if(!this.hasMultiValueItem){var a=[];this.attribFilter.selected_NOT.forEach(function(t){a.push(t)}),a.forEach(function(t){t.set_NONE()})}t.set_OR(this.attribFilter.selected_OR),this.attribFilter.how=1===this.attribFilter.selected_OR.length?"LessResults":"MoreResults",sendLog&&sendLog(kshf.LOG.FILTER_ATTR_ADD_OR,{id:this.attribFilter.id,info:t.id()})}return i&&(this.attribFilter.how=i),s&&(this.attribFilter.how="All"),this.attribFilter.selected_OR.length>0&&(this.attribFilter.selected_AND.length>0||this.attribFilter.selected_NOT.length>0)&&(this.attribFilter.how="All"),0===this.attribFilter.selectedCount_Total()?(this.attribFilter.clearFilter(),void 0):(this.clearLabelTextSearch(),this.attribFilter.linkFilterSummary="",this.attribFilter.addFilter(!0),void 0)},insertAttribs:function(){var t=this,e=null,i=this.dom.attribGroup.selectAll("div.attrib").data(this._attribs,function(t){return t.id()}).enter().append("div").attr("class",function(e){var i="attrib";return t.options.domStyle&&(i+=" "+t.options.domStyle.call(this,e)),i}).attr("highlight","false").attr("selected","0").each(function(e){e.facet=t,e.facetDOM=this,e.isVisible=!0,this.isLinked=t.isLinked,e.pos_y=0,kshf.Util.setTransform(this,"translateY(0px)"),this.tipsy=new Tipsy(this,{gravity:"w",offset_x:2,offset_y:-1,title:function(){if(this.tipsy_title)return this.tipsy_title;t.options.facetTitle;var i=e.facet.hasMultiValueItem;return e.is_AND()||e.is_OR()||e.is_NOT()?"<span class='action'><span class='fa fa-times'></span> Remove</span> from filter":t.attribFilter.selected_Any()?i===!1?"<span class='action'><span class='fa fa-angle-double-left'></span> Change</span> filter":"<span class='action'><span class='fa fa-plus'></span> And ...</span>":"<span class='action'><span class='fa fa-plus'></span> Add</span> filter"}})});this.options.catTooltipText&&i.attr("title",function(e){return t.options.catTooltipText.call(this,e)});var s,a=function(e){if(t.isAttribSelectable(e)){if(e.facetDOM.tipsy_active&&e.facetDOM.tipsy_active.hide(),this.timer)return t.unselectAllAttribs(),t.filterAttrib(e,t.hasMultiValueItem?"AND":"OR","All"),sendLog&&sendLog(kshf.LOG.FILTER_ATTR_EXACT,{id:t.attribFilter.id,info:e.id()}),void 0;if(e.is_NOT())t.filterAttrib(e,"NOT");else if(e.is_AND())t.filterAttrib(e,"AND");else if(e.is_OR())t.filterAttrib(e,"OR");else if(!t.hasMultiValueItem&&t.attribFilter.selected_OR.length>0){if(t.attribFilter.selected_OR.indexOf(e)<0){var i=[];t.attribFilter.selected_OR.forEach(function(t){i.push(t)}),i.forEach(function(t){t.set_NONE()})}t.filterAttrib(e,"OR","All")}else t.filterAttrib(e,t.hasMultiValueItem?"AND":"OR");if(t.hasMultiValueItem){var s=this;this.timer=setTimeout(function(){s.timer=null},500)}}},r=function(i){if(t.tipsy_active&&t.tipsy_active.hide(),t.isAttribSelectable(i))i.facetDOM.setAttribute("selectType",t.hasMultiValueItem?"and":"or"),t.browser.pauseResultPreview||!t.hasMultiValueItem&&0!==t.attribFilter.selected_OR.length||i.is_NOT()||(i.items.forEach(function(e){e.updatePreview(t.parentFacet)}),i.highlightAll(!0),t.browser.refreshResultPreview(),sendLog&&(e&&clearTimeout(e),e=setTimeout(function(){sendLog(kshf.LOG.FILTER_PREVIEW,{id:t.attribFilter.id,info:i.id()})},1e3)));else if(void 0===this.tipsy_title)return;i.facetDOM.tipsy_active=i.facetDOM.tipsy,t.tipsy_active=i.facetDOM.tipsy,i.facetDOM.tipsy_active.options.offset_x=t.browser.hideBars?0:t.chartPreviewAxisScale(i.aggregate_Active),i.facetDOM.tipsy_active.show()},n=function(i){return void 0!==i.skipMouseOut&&i.skipMouseOut===!0?(i.skipMouseOut=!1,void 0):(t.isAttribSelectable(i)&&(i.nohighlightAll(!0),e&&clearTimeout(e),t.browser.items.forEach(function(t){t.resultDOM&&t.resultDOM.setAttribute("highlight",!1)}),t.browser.pauseResultPreview||t.browser.clearResultPreview(),i.facetDOM.tipsy_active&&i.facetDOM.tipsy_active.hide()),void 0)},o=function(){this.addEventListener("dragstart",function(t){s=t.target,t.target.style.opacity=.5},!1),this.addEventListener("dragend",function(t){t.target.style.opacity=""},!1),this.addEventListener("dragover",function(t){t.preventDefault()},!1),this.addEventListener("dragenter",function(t){"clickArea"==t.target.className&&(t.target.style.background="rgba(0,0,150,0.5)")},!1),this.addEventListener("dragleave",function(t){"clickArea"==t.target.className&&(t.target.style.background="")},!1),this.addEventListener("drop",function(e){if(e.preventDefault(),"clickArea"==e.target.className){e.target.style.background="";var i=s.__data__,a=e.target.__data__;t._attribs[a.orderIndex]=i,t._attribs[i.orderIndex]=a;var r=a.orderIndex;a.orderIndex=i.orderIndex,i.orderIndex=r,t.dom.attribs.each(function(t){t.isVisible&&(t.posX=0,t.posY=p*t.orderIndex,kshf.Util.setTransform(this,"translate("+t.posX+"px,"+t.posY+"px)"))})}},!1)},l=function(e){var i=e.facetDOM;i.tipsy_title="<span class='action'><span class='fa fa-plus'></span> Or ...</span>",i.tipsy.hide(),e.facetDOM.tipsy_active=e.facetDOM.tipsy,t.tipsy_active=e.facetDOM.tipsy,e.facetDOM.tipsy_active.options.offset_x=t.browser.hideBars?0:t.chartPreviewAxisScale(e.aggregate_Active)-t.chartPreviewAxisScale.range()[1],e.facetDOM.tipsy_active.show(),i.tipsy.show(),t.tipsy_active=i.tipsy,t.attribFilter.selected_OR.length>0&&t.browser.clearResultPreview(),e.facetDOM.setAttribute("selectType","or"),d3.event.stopPropagation()},h=function(e){this.__data__.facetDOM.tipsy_title=void 0,this.__data__.facetDOM.tipsy.hide(),this.__data__.facetDOM.tipsy.show(),t.tipsy_active=this.__data__.facetDOM.tipsy,e.facetDOM.setAttribute("selectType",t.hasMultiValueItem?"and":"or"),d3.event.stopPropagation()},c=function(e){t.filterAttrib(e,"OR"),this.__data__.facetDOM.tipsy.hide(),d3.event.stopPropagation()},d=function(e){this.__data__.facetDOM.tipsy_title="<span class='action'><span class='fa fa-minus'></span> Not ...</span>",this.__data__.facetDOM.tipsy.hide(),this.__data__.facetDOM.tipsy.show(),e.facetDOM.setAttribute("selectType","not"),t.tipsy_active=this.__data__.facetDOM.tipsy,t.browser.root.attr("preview-not",!0),t.browser.preview_not=!0,t.browser.refreshResultPreview(),d3.event.stopPropagation()},u=function(e){this.__data__.facetDOM.tipsy_title=void 0,this.__data__.facetDOM.tipsy.hide(),this.__data__.facetDOM.tipsy.show(),t.tipsy_active=this.__data__.facetDOM.tipsy,e.facetDOM.setAttribute("selectType",t.hasMultiValueItem?"and":"or"),setTimeout(function(){t.browser.root.attr("preview-not",null)},0),t.browser.preview_not=!1,t.browser.refreshResultPreview(),d3.event.stopPropagation()},f=function(e){t.browser.preview_not=!1,t.filterAttrib(e,"NOT"),this.__data__.facetDOM.tipsy.hide(),setTimeout(function(){t.browser.root.attr("preview-not",null)},1e3),d3.event.stopPropagation()},p=this.browser.line_height,m=i.append("span").attr("class","clickArea").on("click",a).on("mouseenter",r).on("mouseleave",n).attr("draggable",!0).each(o),v=m.append("span").attr("class","filterButtons");v.append("span").attr("class","orButton fa fa-plus-square").on("mouseenter",l).on("mouseout",h).on("click",c),v.append("span").attr("class","notButton fa fa-minus-square").on("mouseover",d).on("mouseout",u).on("click",f);var g=i.append("span").attr("class","attribLabel hasLabelWidth"),_=g.append("span").attr("class","filterButtons");_.append("span").attr("class","orButton fa fa-plus-square"),_.append("span").attr("class","notButton fa fa-minus-square"),g.append("span").attr("class","theLabel").html(this.options.catLabelText);var b=i.append("span").attr("class","item_count_wrapper").style("width",this.browser.getWidth_QueryPreview()+"px");b.append("span").attr("class","item_count");var y=i.append("span").attr("class","barGroup");y.append("span").attr("class",function(e,i){return"bar total "+(t.options.barClassFunc?t.options.barClassFunc(e,i):"")}),y.append("span").attr("class",function(e,i){return"bar active "+(t.options.barClassFunc?t.options.barClassFunc(e,i):"")}),y.append("span").attr("class","bar preview").attr("fast",!0),y.append("span").attr("class","bar preview_compare").attr("hidden",!0),this.dom.attribs=this.dom.attribGroup.selectAll(".attrib"),this.dom.attribClickArea=this.dom.attribs.selectAll(".clickArea"),this.dom.item_count=this.dom.attribs.selectAll(".item_count_wrapper > .item_count"),this.dom.bars_total=this.dom.attribs.selectAll(".barGroup > .total"),this.dom.bars_active=this.dom.attribs.selectAll(".barGroup > .active"),this.dom.bars_preview=this.dom.attribs.selectAll(".barGroup > .preview"),this.dom.bars_preview_compare=this.dom.attribs.selectAll(".barGroup > .preview_compare")},sortAttribs:function(){void 0===this.sortingOpt_Active&&(this.sortingOpt_Active=this.sortingOpts[0]);var t=this.sortingOpt_Active.no_resort!==!0,e=this.sortingOpt_Active.inverse,i=this.sortingOpt_Active.func,s=function(t,e){return e-t};"string"==typeof this._attribs[0].id()&&(s=function(t,e){return e.localeCompare(t)});var a=function(a,r){if(a.selectedForLink&&!r.selectedForLink)return-1;if(r.selectedForLink&&!a.selectedForLink)return 1;if(t){if(!a.f_selected()&&r.f_selected())return 1;if(a.f_selected()&&!r.f_selected())return-1}if(0===a.aggregate_Active&&0!==r.aggregate_Active)return 1;if(0===r.aggregate_Active&&0!==a.aggregate_Active)return-1;var n=i(a,r);return 0===n&&(n=s(a.id(),r.id())),e&&(n=-n),n};this._attribs.sort(a),this._attribs.forEach(function(t,e){t.orderIndex=e})},updateSorting:function(t,e){void 0===this.sortingOpt_Active&&(this.sortingOpt_Active=this.sortingOpts[0]),(this.sortingOpt_Active.custom!==!0||e===!0)&&(this.options.removeInactiveAttrib&&this.updateAttribCount_Visible(),this.refreshScrollDisplayMore(this.attribCount_InDisplay),this.updateSorting_do(t))},updateSorting_do:function(t){var e=this.browser.line_height,i=this;void 0===t&&(t=1e3),this.sortAttribs();var s=-100;"right"===this.options.layout&&(s*=-1),setTimeout(function(){i.dom.attribs.each(function(t){if(!t.isVisible&&t.isVisible_before){this.style.opacity=0;var i=s,a=t.posY;t.posX=i,t.posY=a,kshf.Util.setTransform(this,"translate("+i+"px,"+a+"px)")}if(t.isVisible&&!t.isVisible_before){var a=e*t.orderIndex;kshf.Util.setTransform(this,"translate("+s+"px,"+a+"px)")}(t.isVisible||t.isVisible_before)&&(this.style.visibility="visible",this.style.display="block")}),setTimeout(function(){i.dom.attribs.each(function(t){if(t.isVisible&&t.isVisible_before){var i=0,s=e*t.orderIndex;t.posX=i,t.posY=s,kshf.Util.setTransform(this,"translate("+i+"px,"+s+"px)")}}),setTimeout(function(){i.attribCount_NowVisible>0&&i.dom.attribs.each(function(t){if(t.isVisible&&!t.isVisible_before){this.style.opacity=1;var i=0,s=e*t.orderIndex;t.posX=i,t.posY=s,kshf.Util.setTransform(this,"translate("+i+"px,"+s+"px)")}}),setTimeout(function(){i.cullAttribs()},700)},i.attribCount_NowVisible>0?300:0)},i.attribCount_NowInvisible>0?300:0)},t),this.dom.attribGroupFiller.style("height",this.attribCount_Visible*e-4+"px");var a=i.dom.attribGroup[0][0];0!==this.scrollTop_cache&&kshf.Util.scrollToPos_do(a,0)},cullAttribs:function(){var t=this;this.dom.attribs.each(function(e){return e.isCulled_before=e.isCulled,e.orderIndex<t.attrib_InDisplay_First?(e.isCulled=!0,void 0):e.orderIndex>t.attrib_InDisplay_First+t.attribCount_InDisplay?(e.isCulled=!0,void 0):(e.isCulled=!1,void 0)}).style("visibility",function(t){return t.isCulled||!t.isVisible?"hidden":"visible"}).style("display",function(t){return t.isCulled||!t.isVisible?"none":"block"})},getTicksSkip:function(){var t=this.browser.barChartWidth/25;return this.getMaxAggregate_Active()>1e5&&(t=this.browser.barChartWidth/30),t},refreshChartPreviewAxis:function(){var t=this,e=this.attribHeight,i=this.chartPreviewAxisScale.ticks(this.getTicksSkip());i=i.filter(function(t){return 0===t%1});var s=this.dom.barChartPreviewAxis.selectAll("span.tick").data(i,function(t){return t}),a=this.browser.root.attr("noanim");"true"!==a&&this.browser.root.attr("noanim",!0);var r=function(e){kshf.Util.setTransform(this,"translateX("+t.chartPreviewAxisScale(e)+"px)")},n=s.enter().append("span").attr("class","tick").each(r);"true"!==a&&this.browser.root.attr("noanim",!1),n.append("span").attr("class","line").style("top","-"+e+"px").style("height",e+"px"),n.append("span").attr("class","text").text(function(t){return d3.format("s")(t)}),setTimeout(function(){t.dom.barChartPreviewAxis.selectAll("span.tick").style("opacity",1).each(r)}),s.exit().remove()}},kshf.Facet_Interval=function(t,e){var i=this;this.id=++kshf.num_of_charts,this.browser=t,this.filteredItems=e.items,this.options=e,this.layoutStr=e.layout,this.parentFacet=e.parentFacet,this.height_hist=65,this.height_hist_min=30,this.height_hist_max=100,this.height_slider=10,this.height_labels=16,this.height_bin_top=19,this.height_percentile=0,this.barGap=2,this.histogramMargin=12,this.histogramTopGap=10,this.dom={},this.subFacets=[],this.collapsed=!1,e.collapsed===!0&&(this.collapsed=!0),void 0===e.optimumTickWidth&&(e.optimumTickWidth=50),void 0===e.intervalScale&&(e.intervalScale="linear"),e.showPercentile===!0&&(this.height_percentile=14),this.tickIntegerOnly=!1,e.tickIntegerOnly===!0&&(this.tickIntegerOnly=!0),this.chartPreviewAxisScale=d3.scale.linear(),this.intervalFilter=t.createFilter({name:this.options.facetTitle,browser:this.browser,filteredItems:this.filteredItems,facet:this,onClear:function(){this.divRoot.attr("filtered",!1),this.intervalFilter.filteredBin=void 0,this.resetIntervalFilterActive(),this.refreshIntervalSlider()},onFilter:function(t){console.log("OnIntervalFilter-Filter 1"),"true"!==this.divRoot.attr("filtered")&&this.divRoot.attr("filtered",!0);var e=t.active.min,s=t.active.max;t.max_inclusive||(s-=.01);var a;a=i.isFiltered_min()&&i.isFiltered_max()?function(t){return t>=e&&s>=t}:i.isFiltered_min()?function(t){return t>=e}:function(t){return s>=t
},console.log("OnIntervalFilter-Filter 2"),t.filteredItems.forEach(function(e){var i=e.mappedDataCache[t.id].v;null===i?e.setFilterCache(t.id,!1):e.setFilterCache(t.id,a(i))},this),console.log("OnIntervalFilter-Filter 3"),this.refreshIntervalSlider(),console.log("OnIntervalFilter-Filter 4")},summary_header:this.options.facetTitle,summary_item_cb:function(){return"step"===i.options.intervalScale&&this.active.min+1===this.active.max?"<b>"+this.active.min+"</b>":"time"===i.options.intervalScale?"<b>"+i.intervalTickFormat(this.active.min)+"</b> to <b>"+i.intervalTickFormat(this.active.max)+"</b>":i.isFiltered_min()&&i.isFiltered_max()?"<b>"+this.active.min+"</b> to <b>"+this.active.max+"</b>":i.isFiltered_min()?"<b>at least "+this.active.min+"</b>":"<b>at most "+this.active.max+"</b>"}}),this.intervalFilter.how="All",this.facetFilter=this.intervalFilter;var s=this.intervalFilter.id;this.hasFloat=!1,this.filteredItems.forEach(function(t){var e=this.options.catItemMap(t);null!==e&&(e instanceof Date?this.hasTime=!0:"number"!=typeof e?e=null:this.hasFloat||(this.hasFloat=this.hasFloat||0!==e%1)),t.mappedDataCache[s]={v:e,h:this}},this),this.hasFloat||(this.tickIntegerOnly=!0);var a=function(t){return t.mappedDataCache[s].v},r="log"===this.options.intervalScale;return this.filteredItems=this.filteredItems.filter(function(t){var e=a(t);return null===e?!1:void 0===e?!1:r&&0===e?!1:!0}),this.filteredItems.sort(function(t,e){var i=a(t),s=a(e);return i.getTime&&(i=i.getTime()),s.getTime&&(s=s.getTime()),i-s}),this.intervalRange=e.intervalRange?e.intervalRange:{},void 0===this.intervalRange.min&&(this.intervalRange.min=d3.min(this.filteredItems,a)),void 0===this.intervalRange.max&&(this.intervalRange.max=d3.max(this.filteredItems,a)),"step"===this.options.intervalScale&&this.intervalRange.max++,void 0===this.intervalRange.min?(this.isEmpty=!0,void 0):(this.isEmpty=!1,this.resetIntervalFilterActive(),void 0)},kshf.Facet_Interval.prototype={hasEntityParent:function(){return void 0!==this.parentFacet?this.parentFacet.hasAttribs():void 0},getWidth:function(){return"left"===this.options.layout?this.browser.getWidth_LeftPanel()-this.getWidth_Offset():"right"===this.options.layout?this.browser.getWidth_RightPanel()-this.getWidth_Offset():"bottom"===this.options.layout?this.browser.getWidth_Total()-this.getWidth_Offset():"bottom-mid"===this.options.layout?this.browser.getWidth_MidPanel():void 0},getWidth_Offset:function(){return this.parentFacet?17:0},getHeight_Header:function(){return void 0==this._height_header&&(this._height_header=this.dom.headerGroup[0][0].offsetHeight),this._height_header},getHeight_Extra:function(){return this.height_bin_top+this.height_labels+this.height_slider+this.height_percentile},getHeight:function(){return this.collapsed?this.getHeight_Header()-2:this.getHeight_Header()+this.height_hist+this.getHeight_Extra()-2},getHeight_RangeMax:function(){return this.getHeight_Header()+this.height_hist_max+this.getHeight_Extra()},getHeight_RangeMin:function(){return this.getHeight_Header()+this.height_hist_min+this.getHeight_Extra()},isFiltered:function(){return this.intervalFilter.isFiltered},isFiltered_min:function(){return this.intervalFilter.active.min!==this.intervalRange.min},isFiltered_max:function(){return this.intervalFilter.active.max!==this.intervalRange.max},resetIntervalFilterActive:function(){this.intervalFilter.active={min:this.intervalRange.min,max:this.intervalRange.max}},getMaxBinTotalItems:function(){return d3.max(this.histBins,function(t){return t.length})},getMaxBinActiveItems:function(){return d3.max(this.histBins,function(t){return t.aggregate_Active})},init_DOM:function(){var t=this;this.browser;var e;if(this.parentFacet)e=this.parentFacet.dom.subFacets;else switch(this.options.layout){case"left":e=this.browser.layoutLeft;break;case"right":e=this.browser.layoutRight;break;case"bottom":e=this.browser.layoutBottom;break;case"bottom-mid":e=this.browser.layoutBottom}this.divRoot=e.append("div").attr("class","kshfChart").attr("collapsed",this.collapsed===!1?"false":"true").attr("filtered",!1),kshf.Util.insertHeader.call(this),this.dom.wrapper=this.divRoot.append("div").attr("class","wrapper"),this.dom.facetInterval=this.dom.wrapper.append("div").attr("class","facetInterval"),this.dom.histogram=this.dom.facetInterval.append("div").attr("class","histogram"),this.dom.histogram_bins=this.dom.histogram.append("div").attr("class","bins"),this.dom.barChartPreviewAxis=this.dom.histogram.append("div").attr("class","barChartPreviewAxis"),this.dom.intervalSlider=this.dom.facetInterval.append("div").attr("class","intervalSlider rangeSlider").attr("anim",!0),this.insertSlider(),this.dom.labelGroup=this.dom.facetInterval.append("div").attr("class","labelGroup"),this.options.showPercentile===!0&&(this.dom.percentileGroup=this.dom.facetInterval.append("div").attr("class","percentileGroup"),this.dom.percentileGroup.append("span").attr("class","percentileTitle").html("Percentiles"),this.dom.quantile={},[[10,90],[20,80],[30,70],[40,60]].forEach(function(e){this.dom.quantile[""+e[0]+"_"+e[1]]=this.dom.percentileGroup.append("span").attr("class","quantile q_range q_"+e[0]+"_"+e[1]).each(function(){this.tipsy=new Tipsy(this,{gravity:"s",title:function(){return"<span style='font-weight:300'>%"+e[0]+" - %"+e[1]+" Percentile: <span style='font-weight:500'>"+t.quantile_val[e[0]]+" - "+t.quantile_val[e[1]]+"</span></span>"}})}).on("mouseover",function(){this.tipsy.show()}).on("mouseout",function(){this.tipsy.hide()})},this),[10,20,30,40,50,60,70,80,90].forEach(function(e){this.dom.quantile[e]=this.dom.percentileGroup.append("span").attr("class","quantile q_pos q_"+e).each(function(){this.tipsy=new Tipsy(this,{gravity:"s",title:function(){return"Median: "+t.quantile_val[e]}})}).on("mouseover",function(){this.tipsy.show()}).on("mouseout",function(){this.tipsy.hide()})},this)),0===this.intervalRange.min&&0===this.intervalRange.max&&this.setCollapsed(!0)},updateIntervalWidth:function(t){if(!this.isEmpty&&(void 0===this.intervalRange.width||this.intervalRange.width!==t)){switch(this.intervalRange.width=t,this.optimalTickCount=Math.floor(this.intervalRange.width/this.options.optimumTickWidth),this.options.intervalScale){case"linear":case"step":case"percentage":this.intervalScale=d3.scale.linear();break;case"log":this.intervalScale=d3.scale.log().base(2);break;case"time":this.intervalScale=d3.time.scale.utc()}this.intervalScale.domain([this.intervalRange.min,this.intervalRange.max]).range([0,this.intervalRange.width]).clamp(!0),"step"!==this.options.intervalScale&&this.intervalScale.nice(this.optimalTickCount);var e=this.intervalScale.ticks(this.optimalTickCount);switch(this.tickIntegerOnly&&(e=e.filter(function(t){return 0===t%1})),this.options.intervalScale){case"time":this.intervalTickFormat=this.intervalScale.tickFormat(this.optimalTickCount);break;case"log":for(this.intervalTickFormat=d3.format(".1s");e.length>2*this.optimalTickCount;)e=e.filter(function(t,e){return 0===e%2});break;case"step":var i=this.intervalRange.max-this.intervalRange.min+1;e=new Array(i);for(var s=0;i>s;s++)e[s]=this.intervalRange.min+s;this.intervalTickFormat=d3.format("d");break;default:this.intervalTickFormat=d3.format(this.tickIntegerOnly?"d":".2s")}void 0===this.intervalTicks||this.intervalTicks.length!==e.length?this.updateTicks(e):(this.barWidth=this.intervalRange.width/(1*(e.length-1)),this.refreshBins_Translate(),this.refreshBars_Scale(),this.refreshAxisLabelPos()),this.refreshIntervalSlider()}},updateTicks:function(t){this.intervalTicks=t;var e=this.intervalFilter.id,i=function(t){return t.mappedDataCache[e].v};this.histBins=d3.layout.histogram().bins(this.intervalTicks).value(i)(this.filteredItems);var s=this.intervalScale(t[0]),a=this.intervalScale(t[1]);this.barWidth=a-s,this.updateActiveItems(),this.updateBarScale2Active(),this.insertBins(),this.insertAxisLabels()},insertBins:function(){var t=this,e=null,i=this.intervalFilter.id,s=this.dom.histogram_bins.selectAll("span.bar").data(this.histBins,function(t,e){return e});s.exit().remove();var a=s.enter().append("span").attr("class","bin").each(function(t){this.tipsy=new Tipsy(this,{gravity:"n",offset_y:3,title:function(){return"true"===this.getAttribute("filtered")?"<span class='action'><span class='fa fa-times'></span> Remove</span> filter":"<span class='action'><span class='fa fa-plus'></span> Add</span> filter"}}),t.aggregate_Preview=0,t.forEach(function(e){e.mappedDataCache[i].b=t},this)}),r=function(i){t.browser.pauseResultPreview||(this.parentNode.setAttribute("highlight","selected"),this.parentNode.tipsy.options.offset_x=(t.barWidth-2*t.barGap)/2-5,this.parentNode.tipsy.show(),i.forEach(function(e){e.updatePreview(t.parentFacet)}),t.browser.refreshResultPreview(),sendLog&&(e&&clearTimeout(e),e=setTimeout(function(){sendLog(kshf.LOG.FILTER_PREVIEW,{id:t.intervalFilter.id,info:i.x+"x"+i.dx})},1e3)))},n=function(){this.parentNode.tipsy.hide(),e&&clearTimeout(e),t.browser.pauseResultPreview||(this.parentNode.setAttribute("highlight",!1),t.browser.items.forEach(function(t){t.resultDOM&&t.resultDOM.setAttribute("highlight",!1)}),t.browser.clearResultPreview())},o=function(e){return this.parentNode.tipsy.hide(),t.intervalFilter.filteredBin===this?(this.parentNode.setAttribute("filtered",!1),t.intervalFilter.clearFilter(),void 0):(this.parentNode.setAttribute("filtered","true"),t.intervalFilter.dom_HistogramBar=this,t.intervalFilter.active="time"!==t.options.intervalScale?{min:e.x,max:e.x+e.dx}:{min:e.x,max:new Date(e.x.getTime()+e.dx)},t.intervalFilter.max_inclusive=e.x+e.dx===t.intervalRange.max,t.intervalFilter.filteredBin=this,t.intervalFilter.addFilter(!0),sendLog&&sendLog(kshf.LOG.FILTER_INTRVL_BIN,{id:t.intervalFilter.id,info:t.intervalFilter.active.min+"x"+t.intervalFilter.active.max}),void 0)};a.append("span").attr("class","bar total"),a.append("span").attr("class","bar active").on("mouseover",r).on("mouseout",n).on("click",o),a.append("span").attr("class","bar preview").attr("fast",!0),a.append("span").attr("class","bar preview_compare").attr("hidden",!0),a.append("span").attr("class","item_count").on("mouseover",r).on("mouseout",n).on("click",o),this.dom.histogram_bin=this.dom.histogram_bins.selectAll("span.bin"),this.dom.bars_active=this.dom.histogram_bin.selectAll(".bar.active"),this.dom.bars_total=this.dom.histogram_bin.selectAll(".bar.total"),this.dom.bars_preview=this.dom.histogram_bin.selectAll(".bar.preview"),this.dom.bars_preview_compare=this.dom.histogram_bin.selectAll(".bar.preview_compare"),this.dom.bars_item_count=this.dom.histogram_bin.selectAll(".item_count"),this.refreshBins_Translate(),this.refreshBars_Scale(),this.refreshResultPreview(),this.refreshQueryPreview()},fixIntervalFilterRange:function(){"log"===this.options.intervalScale||"step"===this.options.intervalScale?(this.intervalFilter.active.min=Math.round(this.intervalFilter.active.min),this.intervalFilter.active.max=Math.round(this.intervalFilter.active.max)):"time"===this.options.intervalScale||this.hasFloat||(this.intervalFilter.active.min=Math.round(this.intervalFilter.active.min),this.intervalFilter.active.max=Math.round(this.intervalFilter.active.max))},insertSlider:function(){var t=this;this.dom.intervalSlider.append("span").attr("class","base total").on("mousedown",function(){if(1===d3.event.which){t.dom.intervalSlider.attr("anim",!1);var e=this.parentNode,i=t.intervalScale.invert(d3.mouse(e)[0]);d3.select("body").style("cursor","ew-resize").on("mousemove",function(){var s=t.intervalScale.invert(d3.mouse(e)[0]);t.intervalFilter.active.min=d3.min([i,s]),t.intervalFilter.active.max=d3.max([i,s]),t.fixIntervalFilterRange(),t.refreshIntervalSlider(),this.timer&&(clearTimeout(this.timer),this.timer=null),t.intervalFilter.filteredBin=this,this.timer=setTimeout(function(){t.isFiltered_min()||t.isFiltered_max()?(t.intervalFilter.addFilter(!0),sendLog&&sendLog(kshf.LOG.FILTER_INTRVL_HANDLE,{id:t.intervalFilter.id,info:t.intervalFilter.active.min+"x"+t.intervalFilter.active.m})):t.intervalFilter.clearFilter()},250)}).on("mouseup",function(){t.dom.intervalSlider.attr("anim",!0),d3.select("body").style("cursor","auto").on("mousemove",null).on("mouseup",null)}),d3.event.preventDefault()}}),this.dom.intervalSlider.append("span").attr("class","base active").each(function(){this.tipsy=new Tipsy(this,{gravity:"s",title:function(){return"Drag to filter"}})}).on("mouseout",function(){this.tipsy.hide()}).on("mousedown",function(){if(this.tipsy.hide(),1===d3.event.which&&"time"!==t.options.intervalScale){t.dom.intervalSlider.attr("anim",!1);var e=this.parentNode,i=t.intervalFilter.active.min,s=t.intervalFilter.active.max,a=s-i,r=t.intervalScale.invert(d3.mouse(e)[0]);d3.select("body").style("cursor","ew-resize").on("mousemove",function(){var n=t.intervalScale.invert(d3.mouse(e)[0]),o=n-r;t.intervalFilter.active.min=i+o,t.intervalFilter.active.max=s+o,t.intervalFilter.active.min<t.intervalRange.min&&(t.intervalFilter.active.min=t.intervalRange.min,t.intervalFilter.active.max=t.intervalRange.min+a),t.intervalFilter.active.max>t.intervalRange.max&&(t.intervalFilter.active.max=t.intervalRange.max,t.intervalFilter.active.min=t.intervalRange.max-a),t.fixIntervalFilterRange(),t.refreshIntervalSlider(),this.timer&&(clearTimeout(this.timer),this.timer=null),t.intervalFilter.filteredBin=this,this.timer=setTimeout(function(){t.isFiltered_min()||t.isFiltered_max()?(t.intervalFilter.addFilter(!0),sendLog&&sendLog(kshf.LOG.FILTER_INTRVL_HANDLE,{id:t.intervalFilter.id,info:t.intervalFilter.active.min+"x"+t.intervalFilter.active.max})):t.intervalFilter.clearFilter()},200)}).on("mouseup",function(){t.dom.intervalSlider.attr("anim",!0),d3.select("body").style("cursor","auto").on("mousemove",null).on("mouseup",null)}),d3.event.preventDefault()}});var e=function(e){var i=this;if(1===d3.event.which){t.dom.intervalSlider.attr("anim",!1);var s=this.parentNode;d3.select("body").style("cursor","ew-resize").on("mousemove",function(){i.dragging=!0,console.log("hey 1"),t.browser.pauseResultPreview=!0;var a=t.intervalScale.invert(d3.mouse(s)[0]);if(t.intervalFilter.active[e]=a,console.log("hey 2"),t.intervalFilter.active.min>t.intervalFilter.active.max){var r=t.intervalFilter.active.min;t.intervalFilter.active.min=t.intervalFilter.active.max,t.intervalFilter.active.max=r,e="min"===e?"max":"min"}console.log("hey 3"),t.fixIntervalFilterRange(),t.refreshIntervalSlider(),this.timer&&(clearTimeout(this.timer),this.timer=null),console.log("hey 4"),t.intervalFilter.filteredBin=this,console.log("hey 5"),this.timer=setTimeout(function(){t.isFiltered_min()||t.isFiltered_max()?(console.log("hey 6"),sendLog&&sendLog(kshf.LOG.FILTER_INTRVL_HANDLE,{id:t.intervalFilter.id,info:t.intervalFilter.active.min+"x"+t.intervalFilter.active.max}),console.log("hey 7"),t.intervalFilter.addFilter(!0),console.log("hey 8")):(console.log("hey 9"),t.intervalFilter.clearFilter(),console.log("hey 10"))},200),console.log("hey ZZZ")}).on("mouseup",function(){i.dragging=!1,t.browser.pauseResultPreview=!1,t.dom.intervalSlider.attr("anim",!0),d3.select("body").style("cursor","auto").on("mousemove",null).on("mouseup",null)}),d3.event.preventDefault()}};this.dom.intervalSlider.selectAll("span.handle").data(["min","max"]).enter().append("span").attr("class",function(t){return"handle "+t}).each(function(){this.tipsy=new Tipsy(this,{gravity:"s",title:function(){return"<span class='action fa fa-arrows-h' style='font-weight: 900;'></span> Drag to filter"}})}).on("mouseover",function(){this.dragging!==!0&&this.tipsy.show()}).on("mouseout",function(){this.tipsy.hide()}).on("mousedown",function(t,i){this.tipsy.hide(),e.call(this,t,i)}).append("span").attr("class","invalidArea"),this.dom.selectedItemValue=this.dom.intervalSlider.append("div").attr("class","selectedItemValue"),this.dom.selectedItemValue.append("span").attr("class","circlee"),this.dom.selectedItemValueText=this.dom.selectedItemValue.append("span").attr("class","selected-item-value-text").append("span").attr("class","selected-item-value-text-v")},updateBarScale2Total:function(){this.chartPreviewAxisScale=this.chartPreviewAxisScale.domain([0,this.getMaxBinTotalItems()]).range([0,this.height_hist])},updateBarScale2Active:function(){this.chartPreviewAxisScale=this.chartPreviewAxisScale.domain([0,this.getMaxBinActiveItems()]).range([0,this.height_hist])},updateActiveItems:function(){this.parentFacet&&this.parentFacet.hasAttribs()?this.histBins.forEach(function(t){t.aggregate_Active=0,t.forEach(function(e){e.aggregate_Active>0&&(t.aggregate_Active+=e.aggregate_Self)})}):this.histBins.forEach(function(t){t.aggregate_Active=0,t.forEach(function(e){e.isWanted&&(t.aggregate_Active+=e.aggregate_Self)})})},insertAxisLabels:function(){var t=this,e=this.dom.labelGroup.selectAll("span.tick").data(this.intervalTicks),i=e.enter().append("span").attr("class","tick");e.exit().remove(),i.append("span").attr("class","line"),i.append("span").attr("class","text"),this.dom.labelTicks=this.dom.labelGroup.selectAll("span.tick"),this.dom.labelTicks.selectAll("span.text").text(function(e){var i=t.intervalTickFormat(e);return"percentage"===t.options.intervalScale&&(i+="%"),i}),this.refreshAxisLabelPos()},refreshAxisLabelPos:function(){var t=this,e="step"===this.options.intervalScale?this.barWidth/2:0;this.dom.labelTicks.style("left",function(i){return t.intervalScale(i)+e+"px"})},refreshBins_Translate:function(){var t=this,e="step"===this.options.intervalScale?this.barGap:0;kshf.Util.setTransform(this.dom.histogram_bins[0][0],"translateY("+t.chartPreviewAxisScale.range()[1]+"px)"),kshf.Util.setTransform(this.dom.barChartPreviewAxis[0][0],"translateY("+t.chartPreviewAxisScale.range()[1]+"px)"),this.dom.histogram_bin.each(function(i){kshf.Util.setTransform(this,"translateX("+(t.intervalScale(i.x)+e)+"px)")})},refreshBars_Scale:function(){this.refreshBars_Total_Scale(),this.refreshBars_Active_Scale()},refreshBars_Total_Scale:function(){var t=this,e=this.barWidth-2*this.barGap;this.dom.bars_total.each(function(i){kshf.Util.setTransform(this,"scale("+e+","+t.chartPreviewAxisScale(i.y)+")")})},refreshBars_Active_Scale:function(){var t=this,e=this.barWidth-2*this.barGap;this.dom.bars_active.each(function(i){kshf.Util.setTransform(this,"scale("+e+","+t.chartPreviewAxisScale(i.aggregate_Active)+")")}),this.dom.bars_item_count.each(function(e){kshf.Util.setTransform(this,"translate("+t.barWidth/2+"px,"+-t.chartPreviewAxisScale(e.aggregate_Active)+"px)")})},clearResultPreview_Bars:function(){if(!this.isEmpty){var t=this.barWidth-2*this.barGap;this.dom.bars_preview.each(function(e){e.aggregate_Preview=0,kshf.Util.setTransform(this,"scale("+t+",0)")})}},clearResultPreviewCompare:function(){this.isEmpty||this.dom.bars_preview_compare.each(function(){this.setAttribute("hidden",!0)})},refreshResultPreviewCompare:function(){if(!this.isEmpty&&!this.collapsed){var t=this.chartPreviewAxisScale,e=this.browser.preview_not,i=this.barWidth-2*this.barGap,s="scale("+i+",";this.dom.bars_preview_compare.each(function(i){var a=i.aggregate_Preview;e&&(a=i.aggregate_Active-i.aggregate_Preview),kshf.Util.setTransform(this,s+"1) translateY(-"+t(a)+"px)"),this.setAttribute("hidden",0===a)})}},clearResultPreview:function(){this.isEmpty||this.collapsed||(this.clearResultPreview_Bars(),this.refreshQueryPreview())},refreshResultPreview:function(){if(!this.isEmpty&&!this.collapsed){var t=this.browser.preview_not,e=this.chartPreviewAxisScale,i=this.barWidth-2*this.barGap,s="scale("+i+",";this.dom.bars_preview.each(function(i){var a=i.aggregate_Preview;t&&(a=i.aggregate_Active-i.aggregate_Preview),kshf.Util.setTransform(this,s+e(a)+")")}),this.refreshQueryPreview()}},refreshQueryPreview:function(){var t=this,e=kshf.Util.formatForItemCount;this.dom.histogram_bin.attr("noitems",function(t){return 0===t.aggregate_Active}),this.dom.bars_item_count.text(function(i){if(t.browser.resultPreviewActive!==!0)return e(i.aggregate_Active);var s;return s=t.browser.preview_not?i.aggregate_Active-i.aggregate_Preview:i.aggregate_Preview,e(s)})},refreshIntervalSlider:function(){var t=this,e=this.intervalScale(this.intervalFilter.active.min),i=this.intervalScale(this.intervalFilter.active.max);t.intervalFilter.active.min===t.intervalRange.min&&(e=t.intervalScale.range()[0]),t.intervalFilter.active.max===t.intervalRange.max&&(i=t.intervalScale.range()[1]),this.dom.intervalSlider.select(".base.total").style("width",this.intervalScale.range()[1]+"px"),this.dom.intervalSlider.select(".base.active").attr("filtered",this.isFiltered()).each(function(){kshf.Util.setTransform(this,"translateX("+e+"px) scaleX("+(i-e)+")")}),this.dom.intervalSlider.selectAll(".handle").each(function(t){kshf.Util.setTransform(this,"translateX("+("min"===t?e:i)+"px)")})},refreshWidth:function(){var t=this.getWidth();this.dom.facetInterval.style("width",t+"px"),this.updateIntervalWidth(t-2*this.histogramMargin)},setHeight:function(t){if(void 0!==this.histBins){var e=t-this.getHeight_Header()-this.getHeight_Extra();this.height_hist!==e&&(this.height_hist=e,this.updateBarScale2Active(),this.refreshBins_Translate(),this.refreshBars_Scale(),this.refreshResultPreview(),this.refreshHeight(),this.refreshChartPreviewAxis())}},refreshHeight:function(){this.dom.histogram.style("height",this.height_hist+this.histogramTopGap+"px"),this.dom.wrapper.style("height",(this.collapsed?"0":this.height_hist+this.getHeight_Extra())+"px")},setCollapsed:function(t){this.collapsed=t,this.divRoot.attr("collapsed",this.collapsed===!1?"false":"true"),t===!1&&this.clearResultPreview()},collapseFacet:function(t){this.setCollapsed(t),this.browser.updateLayout_Height(),sendLog&&sendLog(t===!0?kshf.LOG.FACET_COLLAPSE:kshf.LOG.FACET_SHOW,{id:this.id})},updateAfterFilter:function(){this.isEmpty||(this.updateActiveItems(),this.refreshQueryPreview(),this.updateBarPreviewScale2Active(),this.options.showPercentile&&this.updateQuantiles())},updateBarPreviewScale2Active:function(){var t=this;this.updateBarScale2Active(),this.refreshBins_Translate(),this.refreshBars_Scale(),this.dom.bars_preview.attr("fast",null),this.refreshResultPreview(),setTimeout(function(){t.dom.bars_preview.attr("fast",!0)},700)},setSelectedPosition:function(t){if(null!==t&&void 0!==this.intervalScale){var e="step"===this.options.intervalScale?this.barWidth/2:0,i="translateX("+(this.intervalScale(t)+e)+"px)";this.dom.selectedItemValue.each(function(){kshf.Util.setTransform(this,i)}).style("display","block");var s=d3.time.format("%b %-e,'%y");this.dom.selectedItemValueText.text(t instanceof Date?s(t):t)}},hideSelectedPosition:function(){this.dom.selectedItemValue.style("display",null)},updateQuantiles:function(){var t=[],e=this.intervalFilter.id,i=function(t){return t.mappedDataCache[e].v};this.hasEntityParent()?this.filteredItems.forEach(function(e){e.aggregate_Active>0&&t.push(i(e))}):this.filteredItems.forEach(function(e){e.isWanted&&t.push(i(e))}),this.quantile_val={},this.quantile_pos={},[10,20,30,40,50,60,70,80,90].forEach(function(e){this.quantile_val[e]=d3.quantile(t,e/100),this.quantile_pos[e]=this.intervalScale(this.quantile_val[e]),kshf.Util.setTransform(this.dom.quantile[e][0][0],"translateX("+this.quantile_pos[e]+"px)")},this),[[10,90],[20,80],[30,70],[40,60]].forEach(function(t){kshf.Util.setTransform(this.dom.quantile[""+t[0]+"_"+t[1]][0][0],"translateX("+this.quantile_pos[t[0]]+"px) "+"scaleX("+(this.quantile_pos[t[1]]-this.quantile_pos[t[0]])+") ")},this)},refreshChartPreviewAxis:function(){var t=this,e=this.chartPreviewAxisScale.ticks(this.getTicksSkip());e=e.filter(function(t){return 0===t%1});var i=this.dom.barChartPreviewAxis.selectAll("span.tick").data(e,function(t){return t}),s=this.browser.root.attr("noanim");"true"!==s&&this.browser.root.attr("noanim",!0);var a=function(e){kshf.Util.setTransform(this,"translateY(-"+t.chartPreviewAxisScale(e)+"px)")},r=i.enter().append("span").attr("class","tick").each(a);"true"!==s&&this.browser.root.attr("noanim",!1),r.append("span").attr("class","line").style("left","0px").style("width",this.intervalRange.width+"px"),setTimeout(function(){t.dom.barChartPreviewAxis.selectAll("span.tick").style("opacity",1).each(a)}),i.exit().remove()},getTicksSkip:function(){var t=this.height_hist/20;return t}};